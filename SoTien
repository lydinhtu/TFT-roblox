local Players = game:GetService("Players")
local Mouse = Players.LocalPlayer:GetMouse()
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SuKienDiChuyen = ReplicatedStorage:WaitForChild("SuKienDiChuyen")
local DangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")

local UnitDangChon = nil -- Biến lưu con lính đang được chọn
local SelectionBox = Instance.new("SelectionBox") -- Cái khung sáng sáng bao quanh lính
SelectionBox.Color3 = Color3.fromRGB(0, 255, 0)
SelectionBox.LineThickness = 0.1

Mouse.Button1Down:Connect(function()
	-- Nếu đang đánh nhau thì không được chỉnh sửa
	if DangDanhNhau.Value == true then return end

	local target = Mouse.Target
	if not target then return end

	-- 1. NẾU BẤM VÀO MỘT CON LÍNH (PHE TA)
	local model = target:FindFirstAncestorOfClass("Model")
	if model and model:FindFirstChild("Humanoid") then
		local stats = model.Humanoid:FindFirstChild("Stats")
		-- Chỉ chọn được lính phe mình (Ally)
		if stats and stats:FindFirstChild("Team") and stats.Team.Value == "Ally" then
			UnitDangChon = model

			-- Hiện khung chọn lên
			SelectionBox.Adornee = model
			SelectionBox.Parent = model
			print("Đã chọn: " .. model.Name)
			return -- Dừng lại, không xử lý phần di chuyển
		end
	end

	-- 2. NẾU BẤM VÀO SÀN ĐẤU (VÀ ĐANG CHỌN LÍNH)
	if UnitDangChon and (target.Name == "SanDau" or target.Name:match("Tile")) then
		-- Gửi yêu cầu di chuyển lên Server
		local viTriClick = Mouse.Hit.Position
		SuKienDiChuyen:FireServer(UnitDangChon, viTriClick)

		-- Bỏ chọn sau khi di chuyển
		UnitDangChon = nil
		SelectionBox.Adornee = nil
		SelectionBox.Parent = nil
	end
end)
