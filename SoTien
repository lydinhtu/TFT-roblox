local Players = game:GetService("Players")
local player = Players.LocalPlayer
local Mouse = player:GetMouse()
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- === PHẦN 1: HIỂN THỊ TIỀN (Code gốc của bạn) ===
local textLabel = script.Parent -- Script này phải nằm bên trong TextLabel
local leaderstats = player:WaitForChild("leaderstats")
local gold = leaderstats:WaitForChild("Gold")

local function CapNhatTien()
	textLabel.Text = tostring(gold.Value) .. " G"
end

-- Cập nhật lần đầu và lắng nghe thay đổi
CapNhatTien()
gold.Changed:Connect(CapNhatTien)


-- === PHẦN 2: XỬ LÝ CLICK VÀ DI CHUYỂN (Code đã sửa lỗi) ===
local SuKienDiChuyen = ReplicatedStorage:WaitForChild("SuKienDiChuyen")
local DangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")

local UnitDangChon = nil -- Biến lưu con lính đang được chọn
local SelectionBox = Instance.new("SelectionBox") -- Khung sáng bao quanh lính
SelectionBox.Color3 = Color3.fromRGB(0, 255, 0)
SelectionBox.LineThickness = 0.1

local eventChonUnit = ReplicatedStorage:FindFirstChild("SuKienChonUnit")
if not eventChonUnit then
	eventChonUnit = Instance.new("BindableEvent")
	eventChonUnit.Name = "SuKienChonUnit"
	eventChonUnit.Parent = ReplicatedStorage
end

Mouse.Button1Down:Connect(function()
	if DangDanhNhau.Value == true then return end

	local target = Mouse.Target
	if not target then 
		-- [MỚI] Nếu bấm ra ngoài trời thì tắt bảng thông tin
		eventChonUnit:Fire(nil) 
		return 
	end

	-- A. NẾU BẤM VÀO MỘT CON LÍNH (PHE TA)
	local model = target:FindFirstAncestorOfClass("Model")
	if model and model:FindFirstChild("Humanoid") then
		local stats = model.Humanoid:FindFirstChild("Stats")
		if stats and stats:FindFirstChild("Team") and stats.Team.Value == "Ally" then
			UnitDangChon = model

			-- Hiện khung chọn (Code cũ)
			SelectionBox.Adornee = model
			SelectionBox.Parent = model
			print("👉 Đã chọn: " .. model.Name)

			-- >>> [MỚI] GỬI TÍN HIỆU HIỆN BẢNG THÔNG TIN <<<
			eventChonUnit:Fire(model)
			-- >>> KẾT THÚC <<<

			return 
		end
	end

	-- Nếu bấm trúng cái gì khác (đất, quái...) mà không phải lính mình
	-- Thì ẩn bảng thông tin đi cho đỡ vướng
	if not UnitDangChon then
		eventChonUnit:Fire(nil)
	end

	-- B. DI CHUYỂN (Code cũ giữ nguyên)
	if UnitDangChon and (target.Name == "SanDau" or target.Name:match("Tile") or target.Name:match("Slot")) then
		-- ... (Code di chuyển cũ) ...
	end
end)
