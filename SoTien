-- File: StarterGui/SoTien
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local Mouse = player:GetMouse()
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- === PH·∫¶N 1: HI·ªÇN TH·ªä TI·ªÄN ===
local textLabel = script.Parent 
local leaderstats = player:WaitForChild("leaderstats")
local gold = leaderstats:WaitForChild("Gold")

local function CapNhatTien()
	textLabel.Text = tostring(gold.Value) .. " G"
end
CapNhatTien()
gold.Changed:Connect(CapNhatTien)

-- === PH·∫¶N 2: X·ª¨ L√ù CLICK V√Ä DI CHUY·ªÇN ===
local SuKienDiChuyen = ReplicatedStorage:WaitForChild("SuKienDiChuyen")
local DangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")

local UnitDangChon = nil 
local SelectionBox = Instance.new("SelectionBox") 
SelectionBox.Color3 = Color3.fromRGB(0, 255, 0)
SelectionBox.LineThickness = 0.1

local eventChonUnit = ReplicatedStorage:FindFirstChild("SuKienChonUnit")
if not eventChonUnit then
	eventChonUnit = Instance.new("BindableEvent")
	eventChonUnit.Name = "SuKienChonUnit"
	eventChonUnit.Parent = ReplicatedStorage
end

Mouse.Button1Down:Connect(function()
	local target = Mouse.Target

	-- 1. CLICK V√ÄO KH√îNG GIAN TR·ªêNG -> H·ª¶Y CH·ªåN
	if not target then 
		eventChonUnit:Fire(nil) 
		UnitDangChon = nil
		SelectionBox.Adornee = nil
		return 
	end

	-- 2. CLICK V√ÄO L√çNH (ƒê·ªÇ CH·ªåN HO·∫∂C XEM INFO)
	local model = target:FindFirstAncestorOfClass("Model")
	if model and model:FindFirstChild("Humanoid") then
		local stats = model.Humanoid:FindFirstChild("Stats")

		-- Ch·ªâ ch·ªçn ƒë∆∞·ª£c l√≠nh phe m√¨nh
		if stats and stats:FindFirstChild("Team") and stats.Team.Value == "Ally" then
			UnitDangChon = model

			-- Hi·ªán khung ch·ªçn
			SelectionBox.Adornee = model
			SelectionBox.Parent = model
			print("üëâ ƒê√£ ch·ªçn: " .. model.Name)

			-- G·ª≠i t√≠n hi·ªáu hi·ªán b·∫£ng th√¥ng tin (Lu√¥n ch·∫°y k·ªÉ c·∫£ ƒëang ƒë√°nh nhau)
			eventChonUnit:Fire(model) 

			return -- D·ª´ng l·∫°i t·∫°i ƒë√¢y (Ch·ªâ ch·ªçn th√¥i, ch∆∞a l√†m g√¨ kh√°c)
		end
	end

	-- 3. CLICK V√ÄO ƒê·∫§T (ƒê·ªÇ DI CHUY·ªÇN)
	-- [QUAN TR·ªåNG] Ch·ªâ cho ph√©p di chuy·ªÉn n·∫øu KH√îNG ƒê√ÅNH NHAU
	if DangDanhNhau.Value == false then

		if UnitDangChon and (target.Name == "SanDau" or target.Name:match("Tile") or target.Name:match("Slot")) then
			print("üéØ G·ª≠i l·ªánh di chuy·ªÉn ƒë·∫øn: " .. target.Name)

			local viTriClick = Mouse.Hit.Position
			SuKienDiChuyen:FireServer(UnitDangChon, viTriClick)

			-- B·ªè ch·ªçn sau khi di chuy·ªÉn xong (Ho·∫∑c gi·ªØ l·∫°i t√πy b·∫°n)
			UnitDangChon = nil
			SelectionBox.Adornee = nil
			SelectionBox.Parent = nil
			eventChonUnit:Fire(nil) -- T·∫Øt b·∫£ng info n·∫øu mu·ªën
		end

	else
		-- N·∫øu ƒëang ƒë√°nh nhau m√† b·∫•m xu·ªëng ƒë·∫•t -> B·ªè ch·ªçn
		if UnitDangChon and not model then
			UnitDangChon = nil
			SelectionBox.Adornee = nil
			eventChonUnit:Fire(nil)
		end
	end
end)
