local npc = script.Parent
local humanoid = npc:WaitForChild("Humanoid")
local rootPart = npc:WaitForChild("HumanoidRootPart")

-- === CẤU HÌNH ===
local KICH_THUOC_O = 6 
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local bienDangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")

-- Tạo thư mục đặt chỗ nếu chưa có
local folderDatCho = workspace:FindFirstChild("DatCho") or Instance.new("Folder", workspace)
if folderDatCho.Name ~= "DatCho" then folderDatCho.Name = "DatCho" end

-- Chỉ số
local stats = humanoid:WaitForChild("Stats")
local myTeam = stats:WaitForChild("Team").Value
local statsTamDanh = stats:WaitForChild("TamDanh")
local statsSatThuong = stats:WaitForChild("SatThuong")
local statsTocDoDanh = stats:WaitForChild("TocDoDanh")
local statsTocDoDiChuyen = stats:WaitForChild("TocDoDiChuyen")

-- Animation Đánh Thường
local animAttackID = "rbxassetid://507777826"
local animAttackObj = Instance.new("Animation")
animAttackObj.AnimationId = animAttackID
local attackTrack = humanoid:LoadAnimation(animAttackObj)

humanoid.AutoRotate = false 
local daChet = false
local viTriNha = rootPart.Position 
local dangDanhNhauTruocDo = false 

-- Hàm hỗ trợ Grid
local function LayTamO(position)
	local nuaO = KICH_THUOC_O / 2
	local x = (math.floor(position.X / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	local z = (math.floor(position.Z / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	return Vector3.new(x, rootPart.Position.Y, z)
end

-- Hàm tìm ô trống để đi (Tránh đè lên nhau)
local function KiemTraVaDatCho(viTriMuonDen)
	-- Check vật lý (Lính khác)
	for _, v in pairs(workspace:GetChildren()) do
		if v ~= npc and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
			local root = v:FindFirstChild("HumanoidRootPart") or v:FindFirstChild("RootPart")
			if root and (root.Position - viTriMuonDen).Magnitude < 3 then return nil end
		end
	end
	-- Check gạch đặt chỗ
	for _, gach in pairs(folderDatCho:GetChildren()) do
		if (gach.Position - viTriMuonDen).Magnitude < 1 then return nil end
	end

	-- Đặt gạch xí chỗ
	local gachMoi = Instance.new("Part")
	gachMoi.Name = "GachCua_" .. npc.Name
	gachMoi.Size = Vector3.new(1, 1, 1)
	gachMoi.Position = viTriMuonDen
	gachMoi.Anchored = true
	gachMoi.CanCollide = false 
	gachMoi.Transparency = 1 
	gachMoi.Parent = folderDatCho
	game:GetService("Debris"):AddItem(gachMoi, 2)
	return gachMoi 
end

local function DonDepSachSe()
	for _, gach in pairs(folderDatCho:GetChildren()) do
		if gach.Name == "GachCua_" .. npc.Name then gach:Destroy() end
	end
end

humanoid.Died:Connect(function()
	daChet = true
	DonDepSachSe() 
	if attackTrack then attackTrack:Stop() end
	npc:BreakJoints()
	task.wait(2)
	npc:Destroy()
end)

-- === VÒNG LẶP CHÍNH ===
while not daChet do
	task.wait(0.1)
	if humanoid.Health <= 0 then daChet = true break end

	local dangDanhNhauHienTai = bienDangDanhNhau.Value

	-- 1. GIAI ĐOẠN CHUẨN BỊ (NGHỈ NGƠI)
	if dangDanhNhauHienTai == false then
		humanoid.WalkSpeed = 0 
		rootPart.Anchored = false 
		DonDepSachSe()

		if humanoid.Health < humanoid.MaxHealth then humanoid.Health = humanoid.MaxHealth end

		-- Quay về vị trí được xếp
		if dangDanhNhauTruocDo == true then
			rootPart.CFrame = CFrame.new(viTriNha)
		else
			viTriNha = rootPart.Position -- Cập nhật vị trí mới nếu vừa được kéo đi
		end

		dangDanhNhauTruocDo = dangDanhNhauHienTai
		continue 
	end
	dangDanhNhauTruocDo = dangDanhNhauHienTai

	-- 2. GIAI ĐOẠN CHIẾN ĐẤU
	local daRaTran = npc:GetAttribute("DaRaTran")

	if daRaTran == true then
		-- A. Tìm kẻ địch gần nhất
		local mucTieu = nil
		local minDst = math.huge
		for _, v in pairs(workspace:GetChildren()) do
			if v ~= npc and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
				local eStats = v.Humanoid:FindFirstChild("Stats")
				if eStats and eStats:FindFirstChild("Team") and eStats.Team.Value ~= myTeam then
					local dist = (rootPart.Position - v.HumanoidRootPart.Position).Magnitude
					if dist < minDst then
						minDst = dist
						mucTieu = v.HumanoidRootPart
					end
				end
			end
		end

		if mucTieu then
			-- Xoay mặt về phía địch
			local huongNhin = Vector3.new(mucTieu.Position.X, rootPart.Position.Y, mucTieu.Position.Z)
			rootPart.CFrame = rootPart.CFrame:Lerp(CFrame.lookAt(rootPart.Position, huongNhin), 0.2)

			local dist = (rootPart.Position - mucTieu.Position).Magnitude
			local tamDanh = math.max(statsTamDanh.Value, KICH_THUOC_O - 1)

			if dist <= tamDanh then
				-- B. TẤN CÔNG (Đứng lại và đánh)
				humanoid.WalkSpeed = 0 
				DonDepSachSe()

				attackTrack:Play()
				task.wait(0.3) 

				local eHum = mucTieu.Parent:FindFirstChild("Humanoid")
				if eHum and eHum.Health > 0 then
					eHum:TakeDamage(statsSatThuong.Value)
				end
				task.wait(math.max(0.1, (1 / statsTocDoDanh.Value) - 0.3))
			else
				-- C. DI CHUYỂN (Grid System)
				humanoid.WalkSpeed = statsTocDoDiChuyen.Value

				local tamO_Dich = LayTamO(mucTieu.Position)
				local tamO_Minh = LayTamO(rootPart.Position)

				-- Tính ô tiếp theo
				local oTiepTheo = tamO_Minh
				local diffX = tamO_Dich.X - tamO_Minh.X
				local diffZ = tamO_Dich.Z - tamO_Minh.Z

				if math.abs(diffX) >= KICH_THUOC_O then
					oTiepTheo = tamO_Minh + Vector3.new(math.sign(diffX) * KICH_THUOC_O, 0, 0)
				elseif math.abs(diffZ) >= KICH_THUOC_O then
					oTiepTheo = tamO_Minh + Vector3.new(0, 0, math.sign(diffZ) * KICH_THUOC_O)
				end

				-- Kiểm tra đường đi
				local cucGach = KiemTraVaDatCho(oTiepTheo)
				if cucGach then
					humanoid:MoveTo(oTiepTheo)
					-- Chờ đến nơi (có timeout để tránh kẹt)
					local timeout = 0
					while (rootPart.Position - oTiepTheo).Magnitude > 1 and timeout < 10 do
						task.wait(0.05)
						timeout = timeout + 1
					end
					if cucGach then cucGach:Destroy() end
				else
					humanoid:MoveTo(rootPart.Position) -- Kẹt thì đứng yên chút
					task.wait(0.1)
				end
			end
		else
			humanoid:MoveTo(rootPart.Position) -- Không có địch
		end
	else
		-- D. Ở HÀNG CHỜ (Trong khi mọi người đang đánh nhau)
		humanoid.WalkSpeed = 0
		rootPart.Anchored = true
	end
end
