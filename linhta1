local npc = script.Parent
local humanoid = npc:WaitForChild("Humanoid")
local rootPart = npc:WaitForChild("HumanoidRootPart")

-- [QUAN TRỌNG] Lưu vị trí ban đầu
local viTriNha = rootPart.Position 

-- === KẾT NỐI ===
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local bienDangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")

-- === CẤU HÌNH ===
local KICH_THUOC_O = 6 

-- Folder Gạch
if not workspace:FindFirstChild("DatCho") then
	local folder = Instance.new("Folder")
	folder.Name = "DatCho"
	folder.Parent = workspace
end
local folderDatCho = workspace:FindFirstChild("DatCho")

local function LayTamO(position)
	local nuaO = KICH_THUOC_O / 2
	local x = (math.floor(position.X / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	local z = (math.floor(position.Z / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	return Vector3.new(x, rootPart.Position.Y, z)
end

local function KiemTraVaDatCho(viTriMuonDen)
	for _, v in pairs(workspace:GetChildren()) do
		if v ~= npc and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
			local root = v:FindFirstChild("HumanoidRootPart") or v:FindFirstChild("RootPart")
			if root and (root.Position - viTriMuonDen).Magnitude < 3 then return nil end
		end
	end
	for _, gach in pairs(folderDatCho:GetChildren()) do
		if (gach.Position - viTriMuonDen).Magnitude < 1 then return nil end
	end
	local gachMoi = Instance.new("Part")
	gachMoi.Name = "GachCua_" .. npc.Name
	gachMoi.Size = Vector3.new(1, 1, 1)
	gachMoi.Position = viTriMuonDen
	gachMoi.Anchored = true
	gachMoi.CanCollide = false 
	gachMoi.Transparency = 1 
	gachMoi.Parent = folderDatCho
	game:GetService("Debris"):AddItem(gachMoi, 2)
	return gachMoi 
end

-- === ANIMATION & STATS ===
local animationId = "rbxassetid://507777826" 
local animObj = Instance.new("Animation")
animObj.AnimationId = animationId
local attackTrack = humanoid:LoadAnimation(animObj)

local stats = humanoid:WaitForChild("Stats")
local myTeam = stats:WaitForChild("Team").Value
local statsTamDanh = stats:WaitForChild("TamDanh")
local statsSatThuong = stats:WaitForChild("SatThuong")
local statsTocDoDanh = stats:WaitForChild("TocDoDanh")
local statsTocDoDiChuyen = stats:WaitForChild("TocDoDiChuyen")

humanoid.AutoRotate = false 
local daChet = false

local function DonDepSachSe()
	for _, gach in pairs(folderDatCho:GetChildren()) do
		if gach.Name == "GachCua_" .. npc.Name then gach:Destroy() end
	end
end

humanoid.Died:Connect(function()
	daChet = true
	DonDepSachSe() 
	if attackTrack then attackTrack:Stop() end
	rootPart.Anchored = false
	npc:BreakJoints()
	if rootPart:FindFirstChild("HealthBar") then rootPart.HealthBar:Destroy() end
	task.wait(2)
	npc:Destroy()
end)

local dangDanhNhauTruocDo = false 

-- === VÒNG LẶP CHÍNH ===
while not daChet do
	task.wait(0.1) 

	local dangDanhNhauHienTai = bienDangDanhNhau.Value

	-- [[ CHẾ ĐỘ CHỜ (SỬA LỖI TẠI ĐÂY) ]]
	if dangDanhNhauHienTai == false then
		humanoid.WalkSpeed = 0 

		-- [FIX] Nhổ neo để có thể kéo thả được
		rootPart.Anchored = false

		-- [FIX] Dừng múa may
		if attackTrack then attackTrack:Stop() end

		if humanoid.Health < humanoid.MaxHealth then humanoid.Health = humanoid.MaxHealth end
		DonDepSachSe()

		if dangDanhNhauTruocDo == true then
			-- Vừa hết trận -> Reset về nhà
			rootPart.CFrame = CFrame.new(viTriNha)
		else
			-- Đang chờ -> Cập nhật vị trí nhà mới
			viTriNha = rootPart.Position
		end

		dangDanhNhauTruocDo = dangDanhNhauHienTai
		continue 
	end

	dangDanhNhauTruocDo = dangDanhNhauHienTai

	-- [[ CHẾ ĐỘ CHIẾN ĐẤU ]]
	humanoid.WalkSpeed = statsTocDoDiChuyen.Value

	local mucTieu = nil
	local minDst = math.huge

	for _, v in pairs(workspace:GetChildren()) do
		if v ~= npc and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
			local eRoot = v:FindFirstChild("HumanoidRootPart") or v:FindFirstChild("RootPart")
			local eStats = v.Humanoid:FindFirstChild("Stats")
			if eRoot and eStats and eStats:FindFirstChild("Team") then
				if eStats.Team.Value ~= myTeam then
					local dist = (rootPart.Position - eRoot.Position).Magnitude
					if dist < minDst then
						minDst = dist
						mucTieu = eRoot
					end
				end
			end
		end
	end

	if mucTieu then
		local tamO_Dich = LayTamO(mucTieu.Position)
		local tamO_Minh = LayTamO(rootPart.Position)
		local diffX = tamO_Dich.X - tamO_Minh.X
		local diffZ = tamO_Dich.Z - tamO_Minh.Z
		local khoangCachManhattan = math.abs(diffX) + math.abs(diffZ)

		if khoangCachManhattan <= math.max(statsTamDanh.Value, KICH_THUOC_O) then
			-- TẤN CÔNG -> BẬT MỎ NEO
			rootPart.Anchored = true 
			DonDepSachSe() 
			local viTriDichY = Vector3.new(mucTieu.Position.X, rootPart.Position.Y, mucTieu.Position.Z)
			rootPart.CFrame = CFrame.lookAt(rootPart.Position, viTriDichY)
			attackTrack:Play()
			task.wait(0.3) 
			local eHum = mucTieu.Parent:FindFirstChild("Humanoid")
			if eHum and eHum.Health > 0 then eHum:TakeDamage(statsSatThuong.Value) end
			task.wait(statsTocDoDanh.Value - 0.3) 
		else
			-- DI CHUYỂN -> TẮT MỎ NEO
			rootPart.Anchored = false 
			local oTiepTheo = tamO_Minh
			if math.abs(diffX) >= KICH_THUOC_O then
				oTiepTheo = tamO_Minh + Vector3.new(math.sign(diffX) * KICH_THUOC_O, 0, 0)
			elseif math.abs(diffZ) >= KICH_THUOC_O then
				oTiepTheo = tamO_Minh + Vector3.new(0, 0, math.sign(diffZ) * KICH_THUOC_O)
			end
			local cucGach = KiemTraVaDatCho(oTiepTheo)
			if cucGach then
				rootPart.CFrame = CFrame.lookAt(rootPart.Position, Vector3.new(oTiepTheo.X, rootPart.Position.Y, oTiepTheo.Z))
				humanoid:MoveTo(oTiepTheo)
				humanoid.MoveToFinished:Wait() 
				if cucGach then cucGach:Destroy() end
			else
				humanoid:MoveTo(rootPart.Position) 
				task.wait(math.random(1, 3) * 0.1) 
			end
		end
	else
		DonDepSachSe()
	end
end
