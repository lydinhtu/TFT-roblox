local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local bienDangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")
local suKienBatDau = ReplicatedStorage:WaitForChild("SuKienBatDau")

-- Láº¥y máº«u
local quaiVatMau = ServerStorage:WaitForChild("QuaiVat")
local folderBanCo = workspace:WaitForChild("BanCo")

-- [[ GIáº¢I PHÃP Má»šI: Táº O FOLDER CHá»¨A QUÃI ]]
local folderQuaiSong = workspace:FindFirstChild("LivingEnemies") or Instance.new("Folder")
folderQuaiSong.Name = "LivingEnemies"
folderQuaiSong.Parent = workspace

local waveHienTai = 1

-- === Cáº¤U HÃŒNH WAVES ===
local DATA_WAVES = {
	[1] = { ViTri = {"Tile_4_1", "Tile_5_1"}, MauCongThem = 0, MauSac = Color3.fromRGB(200, 200, 200) },
	[2] = { ViTri = {"Tile_4_1", "Tile_5_1", "Tile_3_1", "Tile_4_2"}, MauCongThem = 50, MauSac = Color3.fromRGB(255, 170, 0) },
	[3] = { ViTri = {"Tile_4_1"}, MauCongThem = 1500, MauSac = Color3.fromRGB(255, 0, 0) }
}

local function SinhQuaiVat()
	-- Xá»­ lÃ½ tháº¯ng game
	if not DATA_WAVES[waveHienTai] then
		print("ðŸ† WIN GAME! Reset vá» Wave 1")
		waveHienTai = 1
	end

	local data = DATA_WAVES[waveHienTai]
	print("â™»ï¸ Chuáº©n bá»‹ Äá»£t " .. waveHienTai)

	-- 1. Dá»n dáº¹p sáº¡ch sáº½ folder quÃ¡i cÅ©
	folderQuaiSong:ClearAllChildren()
	task.wait(0.5)

	-- 2. Sinh quÃ¡i má»›i vÃ  bá» vÃ o Folder
	for _, tenO in pairs(data.ViTri) do
		local oCo = folderBanCo:FindFirstChild(tenO)
		if oCo then
			local quaiMoi = quaiVatMau:Clone()
			-- [QUAN TRá»ŒNG] Bá» quÃ¡i vÃ o Folder riÃªng Ä‘á»ƒ dá»… quáº£n lÃ½
			quaiMoi.Parent = folderQuaiSong 
			quaiMoi.Name = "QuaiVat_Wave" .. waveHienTai
			quaiMoi:SetAttribute("DaRaTran", true)

			if quaiMoi:FindFirstChild("HumanoidRootPart") then
				quaiMoi.HumanoidRootPart.CFrame = oCo.CFrame + Vector3.new(0, 3, 0)
			end

			-- TÄƒng sá»©c máº¡nh
			local hum = quaiMoi:FindFirstChild("Humanoid")
			if hum then
				hum.MaxHealth = hum.MaxHealth + data.MauCongThem
				hum.Health = hum.MaxHealth
			end

			-- Äá»•i mÃ u
			for _, part in pairs(quaiMoi:GetChildren()) do
				if part:IsA("BasePart") then part.Color = data.MauSac end
			end
		end
	end
end

suKienBatDau.OnServerEvent:Connect(function()
	if bienDangDanhNhau.Value == true then return end 

	print("ðŸ”” Báº®T Äáº¦U Äá»¢T " .. waveHienTai)
	bienDangDanhNhau.Value = true 

	task.spawn(function()
		while bienDangDanhNhau.Value == true do
			task.wait(1) 

			-- A. Äáº¾M QUÃI (Chá»‰ cáº§n Ä‘áº¿m trong Folder LivingEnemies)
			local soQuaiVat = 0
			for _, mob in pairs(folderQuaiSong:GetChildren()) do
				local hum = mob:FindFirstChild("Humanoid")
				-- Chá»‰ Ä‘áº¿m con nÃ o cÃ²n mÃ¡u
				if hum and hum.Health > 0 then
					soQuaiVat = soQuaiVat + 1
				end
			end

			-- B. Äáº¾M LÃNH TA (Váº«n quÃ©t workspace vÃ¬ lÃ­nh ta do ngÆ°á»i chÆ¡i Ä‘áº·t)
			local soLinhTa = 0
			for _, v in pairs(workspace:GetChildren()) do
				local hum = v:FindFirstChild("Humanoid")
				if hum and hum.Health > 0 and v:GetAttribute("DaChet") ~= true then
					local stats = hum:FindFirstChild("Stats")
					if stats and stats:FindFirstChild("Team") and stats.Team.Value == "Ally" then
						soLinhTa = soLinhTa + 1
					end
				end
			end

			-- [DEBUG] In ra Ä‘á»ƒ kiá»ƒm tra náº¿u bá»‹ lá»—i
			if soQuaiVat > 0 and soQuaiVat < 3 then
				print("âš ï¸ CÃ²n sÃ³t " .. soQuaiVat .. " quÃ¡i chÆ°a cháº¿t.")
			end

			-- C. Xá»¬ LÃ THáº®NG / THUA
			if soQuaiVat == 0 then
				print("ðŸŽ‰ ÄÃƒ DIá»†T Háº¾T QUÃI! THáº®NG Äá»¢T " .. waveHienTai)
				bienDangDanhNhau.Value = false 

				-- ThÆ°á»Ÿng tiá»n
				for _, p in pairs(Players:GetPlayers()) do
					if p:FindFirstChild("leaderstats") then
						p.leaderstats.Gold.Value = p.leaderstats.Gold.Value + (20 + waveHienTai*5)
					end
				end

				waveHienTai = waveHienTai + 1  
				task.wait(2)
				SinhQuaiVat() -- Gá»i Ä‘á»£t tiáº¿p theo
				break

			elseif soLinhTa == 0 then
				print("ðŸ’€ TOÃ€N Bá»˜ LÃNH TA ÄÃƒ CHáº¾T. THUA CUá»˜C.")
				bienDangDanhNhau.Value = false
				task.wait(2)
				SinhQuaiVat() -- Reset láº¡i
				break
			end
		end
	end)
end)

-- Sinh quÃ¡i láº§n Ä‘áº§u
task.wait(2)
SinhQuaiVat()
