-- === Script: GameManager (ÄÃ£ nÃ¢ng cáº¥p xáº¿p Ä‘á»™i hÃ¬nh) ===
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local bienDangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")
local suKienBatDau = ReplicatedStorage:WaitForChild("SuKienBatDau")

-- Láº¥y máº«u
local quaiVatMau = ServerStorage:WaitForChild("QuaiVat")
local folderBanCo = workspace:WaitForChild("BanCo") -- Folder chá»©a cÃ¡c Ã´ Tile_x_z

local waveHienTai = 1

-- DANH SÃCH Vá»Š TRÃ QUÃI Váº¬T THEO Tá»ªNG WAVE (CÃ i Ä‘áº·t vá»‹ trÃ­ trong há»‡ thá»‘ng táº¡i Ä‘Ã¢y)
-- Äá»‹nh dáº¡ng: "Tile_Cá»™t_HÃ ng" (Cá»™t 1-8, HÃ ng 1-8). Äá»‹ch thÆ°á»ng á»Ÿ hÃ ng 7, 8.
local DOI_HINH_ENEMY = {
	[1] = {"Tile_4_1", "Tile_5_1"}, -- Wave 1: 2 con á»Ÿ giá»¯a hÃ ng 7
	[2] = {"Tile_4_1", "Tile_5_1", "Tile_6_1", "Tile_4_2"}, -- Wave 2: 4 con
	[3] = {"Tile_4_1", "Tile_3_1", "Tile_3_2", "Tile_5_1", "Tile_5_2", "Tile_60_2"} -- Wave 3: ÄÃ´ng hÆ¡n
}

local function SinhQuaiVat()
	print("â™»ï¸ Äang chuáº©n bá»‹ Äá»£t " .. waveHienTai)

	-- XÃ³a quÃ¡i cÅ©
	for _, v in pairs(workspace:GetChildren()) do
		if v.Name:match("QuaiVat") then v:Destroy() end -- XÃ³a táº¥t cáº£ cÃ¡i gÃ¬ tÃªn cÃ³ chá»¯ QuaiVat
	end

	task.wait(1)

	-- Láº¥y danh sÃ¡ch vá»‹ trÃ­ cho Wave hiá»‡n táº¡i (Náº¿u chÆ°a cáº¥u hÃ¬nh thÃ¬ láº¥y máº·c Ä‘á»‹nh)
	local danhSachViTri = DOI_HINH_ENEMY[waveHienTai] or {"Tile_4_1", "Tile_5_1"}

	for _, tenO in pairs(danhSachViTri) do
		local oCo = folderBanCo:FindFirstChild(tenO)
		if oCo then
			local quaiMoi = quaiVatMau:Clone()
			quaiMoi.Parent = workspace
			quaiMoi.Name = "QuaiVat_Wave" .. waveHienTai

			-- Äáº·t vá»‹ trÃ­ vÃ o Ä‘Ãºng Ã´ cá» (Cao hÆ¡n 3u Ä‘á»ƒ khÃ´ng bá»‹ káº¹t Ä‘áº¥t)
			if quaiMoi:FindFirstChild("HumanoidRootPart") then
				quaiMoi.HumanoidRootPart.CFrame = oCo.CFrame + Vector3.new(0, 3, 0)
			end

			-- TÄƒng sá»©c máº¡nh theo Wave
			quaiMoi.Humanoid.MaxHealth = quaiMoi.Humanoid.MaxHealth + (waveHienTai * 50)
			quaiMoi.Humanoid.Health = quaiMoi.Humanoid.MaxHealth

			-- ÄÃ¡nh dáº¥u Ä‘Ã¢y lÃ  Enemy (Quan trá»ng Ä‘á»ƒ UnitAI nháº­n diá»‡n)
			local stats = quaiMoi.Humanoid:FindFirstChild("Stats")
			if stats and stats:FindFirstChild("Team") then
				stats.Team.Value = "Enemy"
			end

			-- Set tráº¡ng thÃ¡i "DaRaTran" = true Ä‘á»ƒ AI tá»± cháº¡y khi vÃ o tráº­n
			quaiMoi:SetAttribute("DaRaTran", true) 
		end
	end
end

suKienBatDau.OnServerEvent:Connect(function()
	if bienDangDanhNhau.Value == true then return end 

	print("ğŸ”” Báº®T Äáº¦U Äá»¢T " .. waveHienTai)
	bienDangDanhNhau.Value = true 

	task.spawn(function()
		while bienDangDanhNhau.Value == true do
			task.wait(1) 

			local soLinhTa = 0
			local soQuaiVat = 0

			-- QuÃ©t toÃ n bá»™ map Ä‘á»ƒ Ä‘áº¿m sá»‘ lÆ°á»£ng
			for _, v in pairs(workspace:GetChildren()) do
				-- 1. Bá» qua ngÆ°á»i chÆ¡i tháº­t
				if Players:GetPlayerFromCharacter(v) then continue end

				-- 2. Kiá»ƒm tra náº¿u cÃ²n sá»‘ng VÃ€ KHÃ”NG Bá»Š "GIáº¢ CHáº¾T" (Attribute DaChet)
				if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v:GetAttribute("DaChet") ~= true then
					local stats = v.Humanoid:FindFirstChild("Stats")
					if stats then
						local teamVal = stats:FindFirstChild("Team")
						if teamVal then
							if teamVal.Value == "Ally" then 
								soLinhTa = soLinhTa + 1
							elseif teamVal.Value == "Enemy" then 
								soQuaiVat = soQuaiVat + 1
							end
						end
					end
				end
			end
			-- Kiá»ƒm tra Tháº¯ng/Thua
			if soQuaiVat == 0 then
				print("ğŸ‰ THáº®NG Äá»¢T " .. waveHienTai)
				bienDangDanhNhau.Value = false 

				-- ThÆ°á»Ÿng tiá»n
				for _, p in pairs(Players:GetPlayers()) do
					if p:FindFirstChild("leaderstats") then
						p.leaderstats.Gold.Value = p.leaderstats.Gold.Value + (20 + waveHienTai*5)
					end
				end

				waveHienTai = waveHienTai + 1  
				task.wait(3)
				SinhQuaiVat() 
				break

			elseif soLinhTa == 0 then
				print("ğŸ’€ THUA CUá»˜C.")
				bienDangDanhNhau.Value = false
				task.wait(3)
				SinhQuaiVat() -- Sinh láº¡i wave cÅ© Ä‘á»ƒ chÆ¡i láº¡i
				break
			end
		end
	end)
end)

-- Sinh quÃ¡i láº§n Ä‘áº§u
task.wait(2) -- Äá»£i map load xong
SinhQuaiVat()
