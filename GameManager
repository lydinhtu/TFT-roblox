local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local bienDangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")
local suKienBatDau = ReplicatedStorage:WaitForChild("SuKienBatDau")

-- L·∫•y m·∫´u
local quaiVatMau = ServerStorage:WaitForChild("QuaiVat")
local folderBanCo = workspace:WaitForChild("BanCo") -- Folder ch·ª©a c√°c √¥ c·ªù (Tile_x_z)

local waveHienTai = 1

-- === C·∫§U H√åNH C√ÅC ƒê·ª¢T T·∫§N C√îNG (WAVES) ===
-- B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a v·ªã tr√≠ (Tile_C·ªôt_H√†ng) v√† s·ª©c m·∫°nh t·∫°i ƒë√¢y
local DATA_WAVES = {
	[1] = { -- ƒê·ª£t 1: D·ªÖ
		ViTri = {"Tile_4_1", "Tile_5_1"}, -- 2 con ƒë·ª©ng h√†ng cu·ªëi
		MauCongThem = 0,
		MauSac = Color3.fromRGB(200, 200, 200) -- M√†u tr·∫Øng
	},
	[2] = { -- ƒê·ª£t 2: Trung b√¨nh
		ViTri = {"Tile_4_1", "Tile_5_1", "Tile_3_1", "Tile_4_2"}, -- 4 con
		MauCongThem = 50,
		MauSac = Color3.fromRGB(255, 170, 0) -- M√†u cam
	},
	[3] = { -- ƒê·ª£t 3: Kh√≥ (Boss)
		ViTri = {"Tile_4_1"}, -- 6 con
		MauCongThem = 1500,
		MauSac = Color3.fromRGB(255, 0, 0) -- M√†u ƒë·ªè
	}
}

local function SinhQuaiVat()
	-- 1. Ki·ªÉm tra xem c√≤n data wave kh√¥ng (N·∫øu h·∫øt wave 3 th√¨ quay l·∫°i 1 ho·∫∑c th√¥ng b√°o th·∫Øng)
	if not DATA_WAVES[waveHienTai] then
		print("üèÜ CH√öC M·ª™NG! B·∫†N ƒê√É CHI·∫æN TH·∫ÆNG TO√ÄN B·ªò GAME!")
		waveHienTai = 1 -- Reset v·ªÅ wave 1 ƒë·ªÉ ch∆°i l·∫°i v√¥ t·∫≠n
	end

	local data = DATA_WAVES[waveHienTai]
	print("‚ôªÔ∏è ƒêang chu·∫©n b·ªã ƒê·ª£t " .. waveHienTai .. " - S·ªë l∆∞·ª£ng: " .. #data.ViTri)

	-- 2. X√≥a qu√°i c≈©
	for _, v in pairs(workspace:GetChildren()) do
		if v.Name:match("QuaiVat") then v:Destroy() end
	end

	task.wait(1)

	-- 3. Sinh qu√°i theo danh s√°ch v·ªã tr√≠
	for _, tenO in pairs(data.ViTri) do
		-- T√¨m √¥ c·ªù tr√™n b·∫£n ƒë·ªì
		local oCo = folderBanCo:FindFirstChild(tenO)

		if oCo then
			local quaiMoi = quaiVatMau:Clone()
			quaiMoi.Parent = workspace
			quaiMoi.Name = "QuaiVat_Wave" .. waveHienTai

			-- ƒê·∫∑t v·ªã tr√≠ v√†o T√ÇM √î (C·ªông th√™m Y=3 ƒë·ªÉ ƒë·ª©ng tr√™n m·∫∑t ƒë·∫•t)
			if quaiMoi:FindFirstChild("HumanoidRootPart") then
				quaiMoi.HumanoidRootPart.CFrame = oCo.CFrame + Vector3.new(0, 3, 0)
			end

			-- C√†i ƒë·∫∑t ch·ªâ s·ªë theo Wave
			quaiMoi.Humanoid.MaxHealth = quaiMoi.Humanoid.MaxHealth + data.MauCongThem
			quaiMoi.Humanoid.Health = quaiMoi.Humanoid.MaxHealth

			-- [QUAN TR·ªåNG] C·∫•p quy·ªÅn "ƒê√£ Ra Tr·∫≠n" ƒë·ªÉ AI t·ª± ch·∫°y
			quaiMoi:SetAttribute("DaRaTran", true)

			-- ƒê·ªïi m√†u ƒë·ªÉ ph√¢n bi·ªát ƒë·ªô kh√≥
			for _, part in pairs(quaiMoi:GetChildren()) do
				if part:IsA("BasePart") then
					part.Color = data.MauSac
				end
			end
		else
			warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y √¥: " .. tenO .. ". Ki·ªÉm tra l·∫°i t√™n trong MapGenerator!")
		end
	end
end

suKienBatDau.OnServerEvent:Connect(function()
	if bienDangDanhNhau.Value == true then return end 

	print("üîî B·∫ÆT ƒê·∫¶U ƒê·ª¢T " .. waveHienTai)
	bienDangDanhNhau.Value = true 

	task.spawn(function()
		while bienDangDanhNhau.Value == true do
			task.wait(1) 

			local soLinhTa = 0
			local soQuaiVat = 0

			-- Qu√©t to√†n b·ªô map ƒë·∫øm s·ªë l∆∞·ª£ng
			for _, v in pairs(workspace:GetChildren()) do
				if Players:GetPlayerFromCharacter(v) then continue end

				local hum = v:FindFirstChild("Humanoid")
				local root = v:FindFirstChild("HumanoidRootPart")

				-- [QUY T·∫ÆC ƒê·∫æM CHU·∫®N]
				-- 1. C√≥ Humanoid & RootPart
				-- 2. M√°u > 0
				-- 3. ƒê·ª©ng tr√™n s√†n (Y > -10 v√† Y < 50) - Tr√°nh ƒë·∫øm qu√°i r∆°i v·ª±c ho·∫∑c bay l√™n tr·ªùi
				if hum and hum.Health > 0 and root then
					if root.Position.Y > -10 and root.Position.Y < 50 then
						local stats = hum:FindFirstChild("Stats")
						if stats then
							local teamVal = stats:FindFirstChild("Team")
							if teamVal then
								-- L√≠nh ta: Ph·∫£i ch∆∞a "Ch·∫øt gi·∫£" (Attribute DaChet)
								if teamVal.Value == "Ally" and v:GetAttribute("DaChet") ~= true then 
									soLinhTa = soLinhTa + 1
									-- Qu√°i v·∫≠t: C·ª© th·∫•y l√† ƒë·∫øm
								elseif teamVal.Value == "Enemy" then 
									soQuaiVat = soQuaiVat + 1
								end
							end
						end
					end
				end
			end

			-- X·ª¨ L√ù K·∫æT QU·∫¢
			if soQuaiVat == 0 then
				print("üéâ TH·∫ÆNG ƒê·ª¢T " .. waveHienTai)
				bienDangDanhNhau.Value = false 

				-- Th∆∞·ªüng ti·ªÅn
				for _, p in pairs(Players:GetPlayers()) do
					if p:FindFirstChild("leaderstats") then
						p.leaderstats.Gold.Value = p.leaderstats.Gold.Value + (20 + waveHienTai*5)
					end
				end

				waveHienTai = waveHienTai + 1  
				task.wait(2)
				SinhQuaiVat() -- Sinh wave ti·∫øp theo
				break

			elseif soLinhTa == 0 then
				print("üíÄ THUA CU·ªòC.")
				bienDangDanhNhau.Value = false
				task.wait(2)
				SinhQuaiVat() -- Reset l·∫°i wave hi·ªán t·∫°i ƒë·ªÉ ch∆°i l·∫°i
				break
			end
		end
	end)
end)

-- Sinh qu√°i l·∫ßn ƒë·∫ßu khi server ch·∫°y
task.wait(2) -- ƒê·ª£i map load xong
SinhQuaiVat()
