local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local bienDangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")
local suKienBatDau = ReplicatedStorage:WaitForChild("SuKienBatDau")

-- L·∫•y m·∫´u
local quaiVatMau = ServerStorage:WaitForChild("QuaiVat")
local folderBanCo = workspace:WaitForChild("BanCo")

-- Folder ch·ª©a qu√°i
local folderQuaiSong = workspace:FindFirstChild("LivingEnemies") or Instance.new("Folder")
folderQuaiSong.Name = "LivingEnemies"
folderQuaiSong.Parent = workspace

local waveHienTai = 1
local dangXuLyWave = false -- Bi·∫øn kh√≥a c·ª•c b·ªô ƒë·ªÉ tr√°nh l·ªói spam n√∫t

-- === C·∫§U H√åNH WAVES ===
local DATA_WAVES = {
	[1] = { ViTri = {"Tile_4_1", "Tile_5_1"}, MauCongThem = 0, MauSac = Color3.fromRGB(200, 200, 200) },
	[2] = { ViTri = {"Tile_4_1", "Tile_5_1", "Tile_3_1", "Tile_4_2"}, MauCongThem = 50, MauSac = Color3.fromRGB(255, 170, 0) },
	[3] = { ViTri = {"Tile_4_1"}, MauCongThem = 1500, MauSac = Color3.fromRGB(255, 0, 0) }
}

local function SinhQuaiVat()
	if not DATA_WAVES[waveHienTai] then
		print("üèÜ WIN GAME! Reset v·ªÅ Wave 1")
		waveHienTai = 1
	end

	local data = DATA_WAVES[waveHienTai]
	print("‚ôªÔ∏è Chu·∫©n b·ªã ƒê·ª£t " .. waveHienTai)

	-- D·ªçn d·∫πp folder qu√°i c≈©
	folderQuaiSong:ClearAllChildren()
	task.wait(0.5)

	-- Sinh qu√°i m·ªõi
	for _, tenO in pairs(data.ViTri) do
		local oCo = folderBanCo:FindFirstChild(tenO)
		if oCo then
			local quaiMoi = quaiVatMau:Clone()
			quaiMoi.Parent = folderQuaiSong
			quaiMoi.Name = "QuaiVat_Wave" .. waveHienTai
			quaiMoi:SetAttribute("DaRaTran", true)

			if quaiMoi:FindFirstChild("HumanoidRootPart") then
				quaiMoi.HumanoidRootPart.CFrame = oCo.CFrame + Vector3.new(0, 3, 0)
			end

			local hum = quaiMoi:FindFirstChild("Humanoid")
			if hum then
				hum.MaxHealth = hum.MaxHealth + data.MauCongThem
				hum.Health = hum.MaxHealth
			end

			for _, part in pairs(quaiMoi:GetChildren()) do
				if part:IsA("BasePart") then part.Color = data.MauSac end
			end
		end
	end
end

suKienBatDau.OnServerEvent:Connect(function()
	-- [FIX XUNG ƒê·ªòT] D√πng bi·∫øn c·ª•c b·ªô ƒë·ªÉ ki·ªÉm so√°t thay v√¨ ph·ª• thu·ªôc ho√†n to√†n v√†o Value
	if dangXuLyWave == true then return end 
	dangXuLyWave = true

	print("üîî B·∫ÆT ƒê·∫¶U ƒê·ª¢T " .. waveHienTai)
	bienDangDanhNhau.Value = true 

	task.spawn(function()
		while bienDangDanhNhau.Value == true do
			task.wait(1) 

			local soLinhTa = 0
			local soQuaiVat = 0
			local danhSachKeCungDau = {} 

			-- === A. KI·ªÇM TRA QU√ÅI V·∫¨T ===
			for _, mob in pairs(folderQuaiSong:GetChildren()) do
				local hum = mob:FindFirstChild("Humanoid")
				local root = mob:FindFirstChild("HumanoidRootPart")

				if hum and root then
					-- [M√ÅY CH√âM: R∆°i xu·ªëng v·ª±c l√† x√≥a ngay]
					if root.Position.Y < -20 then
						print("üóëÔ∏è X√≥a qu√°i r∆°i xu·ªëng v·ª±c: " .. mob.Name)
						mob:Destroy() 
					elseif hum.Health > 0 then
						soQuaiVat = soQuaiVat + 1
						table.insert(danhSachKeCungDau, mob.Name)
					end
				else
					mob:Destroy()
				end
			end

			-- === B. KI·ªÇM TRA L√çNH TA ===
			for _, v in pairs(workspace:GetChildren()) do
				local hum = v:FindFirstChild("Humanoid")
				local root = v:FindFirstChild("HumanoidRootPart")

				if hum and root and v:GetAttribute("DaChet") ~= true then
					local stats = hum:FindFirstChild("Stats")
					if stats and stats:FindFirstChild("Team") and stats.Team.Value == "Ally" then
						if root.Position.Y < -20 then
							print("üíÄ L√≠nh ta r∆°i xu·ªëng v·ª±c: " .. v.Name)
							hum.Health = 0 
						elseif hum.Health > 0 then
							soLinhTa = soLinhTa + 1
						end
					end
				end
			end

			-- [DEBUG]
			if soQuaiVat > 0 and soQuaiVat <= 3 then
				print("‚ö†Ô∏è Wave ch∆∞a h·∫øt do c√≤n: " .. table.concat(danhSachKeCungDau, ", "))
			end

			-- === C. X·ª¨ L√ù K·∫æT QU·∫¢ ===
			if soQuaiVat == 0 then
				print("üéâ TH·∫ÆNG ƒê·ª¢T " .. waveHienTai)
				bienDangDanhNhau.Value = false 
				dangXuLyWave = false -- M·ªü kh√≥a ƒë·ªÉ b·∫•m n√∫t l·∫ßn sau

				-- Th∆∞·ªüng ti·ªÅn
				for _, p in pairs(Players:GetPlayers()) do
					if p:FindFirstChild("leaderstats") then
						p.leaderstats.Gold.Value = p.leaderstats.Gold.Value + (20 + waveHienTai*5)
					end
				end

				waveHienTai = waveHienTai + 1  
				task.wait(2)
				SinhQuaiVat() 
				break

			elseif soLinhTa == 0 then
				print("üíÄ THUA CU·ªòC.")
				bienDangDanhNhau.Value = false
				dangXuLyWave = false
				task.wait(2)
				SinhQuaiVat()
				break
			end
		end
	end)
end)

-- Sinh qu√°i l·∫ßn ƒë·∫ßu
task.wait(2)
SinhQuaiVat()
