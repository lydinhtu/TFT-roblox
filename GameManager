local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local bienDangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")
local suKienBatDau = ReplicatedStorage:WaitForChild("SuKienBatDau")

-- Láº¥y máº«u
local quaiVatMau = ServerStorage:WaitForChild("QuaiVat")
local viTriXuatHien = Vector3.new(0, 5, -20) 

local waveHienTai = 1

local function SinhQuaiVat()
	print("â™»ï¸ Äang chuáº©n bá»‹ Äá»£t " .. waveHienTai)
	for _, v in pairs(workspace:GetChildren()) do
		if v.Name == "QuaiVat" then v:Destroy() end
	end

	task.wait(1)

	local quaiMoi = quaiVatMau:Clone()
	quaiMoi.Parent = workspace
	if quaiMoi:FindFirstChild("HumanoidRootPart") then
		quaiMoi.HumanoidRootPart.CFrame = CFrame.new(viTriXuatHien)
	end

	quaiMoi.Humanoid.MaxHealth = quaiMoi.Humanoid.MaxHealth + (waveHienTai * 50)
	quaiMoi.Humanoid.Health = quaiMoi.Humanoid.MaxHealth

	for _, part in pairs(quaiMoi:GetChildren()) do
		if part:IsA("BasePart") then
			part.Color = Color3.fromHSV((waveHienTai * 0.15) % 1, 1, 1)
		end
	end
end

suKienBatDau.OnServerEvent:Connect(function()
	if bienDangDanhNhau.Value == true then return end 

	print("ğŸ”” Báº®T Äáº¦U Äá»¢T " .. waveHienTai)
	bienDangDanhNhau.Value = true 

	task.spawn(function()
		while bienDangDanhNhau.Value == true do
			task.wait(1) 

			local soLinhTa = 0
			local soQuaiVat = 0

			-- QuÃ©t toÃ n bá»™ map
			for _, v in pairs(workspace:GetChildren()) do
				-- 1. Bá» qua náº¿u lÃ  ngÆ°á»i chÆ¡i tháº­t
				if Players:GetPlayerFromCharacter(v) then 
					continue 
				end

				-- 2. Chá»‰ kiá»ƒm tra náº¿u cÃ²n sá»‘ng
				if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
					local hum = v.Humanoid

					-- 3. [QUAN TRá»ŒNG] Kiá»ƒm tra ká»¹ xem cÃ³ Stats khÃ´ng rá»“i má»›i Ä‘á»c
					local stats = hum:FindFirstChild("Stats")
					if stats then
						local teamVal = stats:FindFirstChild("Team")
						if teamVal then
							-- Äáº¿m phe
							if teamVal.Value == "Ally" then 
								soLinhTa = soLinhTa + 1
							elseif teamVal.Value == "Enemy" then 
								soQuaiVat = soQuaiVat + 1
							end
						end
					end
				end
			end

			-- In ra Ä‘á»ƒ báº¡n kiá»ƒm tra xem nÃ³ Ä‘ang Ä‘áº¿m Ä‘Æ°á»£c gÃ¬ (Báº­t Output lÃªn xem)
			-- print("Äang Ä‘áº¿m: Ta=" .. soLinhTa .. " | Äá»‹ch=" .. soQuaiVat)

			-- Xá»¬ LÃ Káº¾T QUáº¢
			if soQuaiVat == 0 then
				print("ğŸ‰ Äá»ŠCH ÄÃƒ CHáº¾T Háº¾T! THáº®NG Äá»¢T " .. waveHienTai)
				bienDangDanhNhau.Value = false 

				-- ThÆ°á»Ÿng tiá»n
				for _, p in pairs(Players:GetPlayers()) do
					if p:FindFirstChild("leaderstats") then
						p.leaderstats.Gold.Value = p.leaderstats.Gold.Value + (20 + waveHienTai*5)
					end
				end

				waveHienTai = waveHienTai + 1  
				task.wait(2)
				SinhQuaiVat() 
				break

			elseif soLinhTa == 0 then
				print("ğŸ’€ QUÃ‚N TA CHáº¾T Háº¾T! THUA CUá»˜C.")
				bienDangDanhNhau.Value = false
				task.wait(2)
				SinhQuaiVat() 
				break
			end
		end
	end)
end)

SinhQuaiVat()
