-- File: StarterGui/GemInventoryUI
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GemConfig = require(ReplicatedStorage:WaitForChild("GemConfig"))
local remoteGemDrop = ReplicatedStorage:WaitForChild("SuKienNhatGem")
local Mouse = Players.LocalPlayer:GetMouse()

-- T·∫°o RemoteEvent trang b·ªã (n·∫øu ch∆∞a c√≥ th√¨ script s·∫Ω ƒë·ª£i server t·∫°o)
local remoteEquip = ReplicatedStorage:WaitForChild("SuKienTrangBiGem", 10) 

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- 1. T·∫†O GIAO DI·ªÜN
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GemUI"
screenGui.Parent = playerGui

local frame = Instance.new("ScrollingFrame")
frame.Name = "InventoryFrame"
frame.Size = UDim2.new(0.15, 0, 0.4, 0)
frame.Position = UDim2.new(0, 10, 0.3, 0)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
frame.BackgroundTransparency = 0.5
frame.BorderSizePixel = 2
frame.BorderColor3 = Color3.fromRGB(255, 215, 0)
frame.Parent = screenGui

local layout = Instance.new("UIGridLayout")
layout.CellSize = UDim2.new(0.45, 0, 0.2, 0)
layout.CellPadding = UDim2.new(0.03, 0, 0.02, 0)
layout.Parent = frame

-- BI·∫æN L∆ØU TR·∫†NG TH√ÅI CH·ªåN
local gemDangChon = nil 
local lastButton = nil

-- 2. H√ÄM TH√äM GEM
local function ThemGemVaoTui(gemID)
	local info = GemConfig[gemID]
	if not info then return end

	local itemBtn = Instance.new("TextButton")
	itemBtn.Name = gemID
	itemBtn.BackgroundColor3 = info.Color
	itemBtn.Text = "" 
	itemBtn.Parent = frame

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0.2, 0)
	corner.Parent = itemBtn

	local lblName = Instance.new("TextLabel")
	lblName.Text = info.Name
	lblName.Size = UDim2.new(1,0,1,0)
	lblName.BackgroundTransparency = 1
	lblName.Font = Enum.Font.SourceSansBold
	lblName.TextColor3 = Color3.new(1,1,1)
	lblName.TextWrapped = true
	lblName.Parent = itemBtn

	-- [S·ª∞ KI·ªÜN CLICK CH·ªåN NG·ªåC]
	itemBtn.MouseButton1Click:Connect(function()
		if gemDangChon == gemID then
			-- B·ªè ch·ªçn
			gemDangChon = nil
			itemBtn.BorderSizePixel = 0
			lastButton = nil
			print("ƒê√£ b·ªè ch·ªçn ng·ªçc")
		else
			-- Ch·ªçn m·ªõi
			if lastButton then lastButton.BorderSizePixel = 0 end -- Reset n√∫t c≈©
			gemDangChon = gemID
			lastButton = itemBtn
			itemBtn.BorderSizePixel = 4 -- Vi·ªÅn s√°ng l√™n
			itemBtn.BorderColor3 = Color3.new(1, 1, 1)
			print("ƒêang c·∫ßm ng·ªçc: " .. info.Name .. ". H√£y b·∫•m v√†o l√≠nh ƒë·ªÉ l·∫Øp!")
		end
	end)
end

-- 3. CLICK V√ÄO L√çNH ƒê·ªÇ TRANG B·ªä
Mouse.Button1Down:Connect(function()
	if gemDangChon and Mouse.Target then
		local model = Mouse.Target:FindFirstAncestorOfClass("Model")

		-- Ki·ªÉm tra xem c√≥ ph·∫£i l√≠nh phe ta kh√¥ng
		if model and model:FindFirstChild("Humanoid") then
			local stats = model.Humanoid:FindFirstChild("Stats")
			if stats and stats:FindFirstChild("Team") and stats.Team.Value == "Ally" then

				print("üõ†Ô∏è G·ª≠i y√™u c·∫ßu trang b·ªã " .. gemDangChon .. " cho " .. model.Name)

				if remoteEquip then
					remoteEquip:FireServer(gemDangChon, model)
				end

				-- Reset sau khi trang b·ªã
				gemDangChon = nil
				if lastButton then 
					lastButton:Destroy() -- X√≥a ng·ªçc kh·ªèi t√∫i (ho·∫∑c gi·ªØ l·∫°i t√πy b·∫°n)
					lastButton = nil
				end
			end
		end
	end
end)

-- 4. NH·∫¨N NG·ªåC
remoteGemDrop.OnClientEvent:Connect(function(gemID)
	ThemGemVaoTui(gemID)
end)
