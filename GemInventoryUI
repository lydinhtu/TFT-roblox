-- File: StarterGui/GemInventoryUI
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GemConfig = require(ReplicatedStorage:WaitForChild("GemConfig"))
local remoteGemDrop = ReplicatedStorage:WaitForChild("SuKienNhatGem")
local Mouse = Players.LocalPlayer:GetMouse()

-- Táº¡o RemoteEvent (Náº¿u chÆ°a cÃ³)
local remoteEquip = ReplicatedStorage:WaitForChild("SuKienTrangBiGem", 10) 

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- 1. Táº O GIAO DIá»†N
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GemUI"
screenGui.Parent = playerGui

local frame = Instance.new("ScrollingFrame")
frame.Name = "InventoryFrame"
frame.Size = UDim2.new(0.15, 0, 0.4, 0)
frame.Position = UDim2.new(0, 10, 0.3, 0)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
frame.BackgroundTransparency = 0.5
frame.BorderSizePixel = 2
frame.BorderColor3 = Color3.fromRGB(255, 215, 0)
frame.Parent = screenGui

local layout = Instance.new("UIGridLayout")
layout.CellSize = UDim2.new(0.45, 0, 0.2, 0)
layout.CellPadding = UDim2.new(0.03, 0, 0.02, 0)
layout.Parent = frame

-- BIáº¾N LÆ¯U TRáº NG THÃI
local gemDangChon = nil 
local lastButton = nil -- NÃºt Ä‘ang Ä‘Æ°á»£c chá»n (Ä‘á»ƒ xÃ³a sau nÃ y)

-- 2. HÃ€M THÃŠM GEM
local function ThemGemVaoTui(gemID)
	local info = GemConfig[gemID]
	if not info then return end

	local itemBtn = Instance.new("TextButton")
	itemBtn.Name = gemID -- Äáº·t tÃªn nÃºt lÃ  ID ngá»c Ä‘á»ƒ dá»… tÃ¬m
	itemBtn.BackgroundColor3 = info.Color
	itemBtn.Text = "" 
	itemBtn.Parent = frame

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0.2, 0)
	corner.Parent = itemBtn

	local lblName = Instance.new("TextLabel")
	lblName.Text = info.Name
	lblName.Size = UDim2.new(1,0,1,0)
	lblName.BackgroundTransparency = 1
	lblName.Font = Enum.Font.SourceSansBold
	lblName.TextColor3 = Color3.new(1,1,1)
	lblName.TextWrapped = true
	lblName.Parent = itemBtn

	-- [Sá»° KIá»†N CLICK CHá»ŒN NGá»ŒC]
	itemBtn.MouseButton1Click:Connect(function()
		if gemDangChon == gemID then
			-- Bá» chá»n
			gemDangChon = nil
			itemBtn.BorderSizePixel = 0
			lastButton = nil
			print("ÄÃ£ bá» chá»n ngá»c")
		else
			-- Chá»n má»›i
			if lastButton then lastButton.BorderSizePixel = 0 end -- Reset nÃºt cÅ©
			gemDangChon = gemID
			lastButton = itemBtn -- LÆ°u láº¡i nÃºt nÃ y Ä‘á»ƒ tÃ­ ná»¯a Server báº£o xÃ³a thÃ¬ xÃ³a
			itemBtn.BorderSizePixel = 4
			itemBtn.BorderColor3 = Color3.new(1, 1, 1)
			print("Äang cáº§m ngá»c: " .. info.Name)
		end
	end)
end

-- 3. CLICK VÃ€O LÃNH -> Gá»¬I YÃŠU Cáº¦U (KHÃ”NG XÃ“A NÃšT á» ÄÃ‚Y)
Mouse.Button1Down:Connect(function()
	if gemDangChon and Mouse.Target then
		local model = Mouse.Target:FindFirstAncestorOfClass("Model")

		if model and model:FindFirstChild("Humanoid") then
			local stats = model.Humanoid:FindFirstChild("Stats")
			if stats and stats:FindFirstChild("Team") and stats.Team.Value == "Ally" then
				print("ğŸ› ï¸ Gá»­i yÃªu cáº§u láº¯p ngá»c...")
				if remoteEquip then
					remoteEquip:FireServer(gemDangChon, model)
				end
				-- [QUAN TRá»ŒNG] KhÃ´ng xÃ³a nÃºt á»Ÿ Ä‘Ã¢y ná»¯a!
				-- Chá» Server tráº£ lá»i má»›i xÃ³a.
			end
		end
	end
end)

-- 4. NHáº¬N NGá»ŒC Má»šI Tá»ª SERVER
remoteGemDrop.OnClientEvent:Connect(function(gemID)
	ThemGemVaoTui(gemID)
end)

-- 5. [Má»šI] NHáº¬N PHáº¢N Há»’I Láº®P THÃ€NH CÃ”NG -> XÃ“A NÃšT
remoteEquip.OnClientEvent:Connect(function(gemID, isSuccess)
	if isSuccess then
		print("ğŸ‰ Láº¯p thÃ nh cÃ´ng! XÃ³a ngá»c khá»i tÃºi.")

		-- XÃ³a cÃ¡i nÃºt Ä‘ang chá»n (lastButton)
		if lastButton and lastButton.Name == gemID then
			lastButton:Destroy()
			lastButton = nil
			gemDangChon = nil
		else
			-- Náº¿u lá»¡ tay chá»n cÃ¡i khÃ¡c rá»“i thÃ¬ tÃ¬m trong tÃºi Ä‘á»ƒ xÃ³a
			local nutCanXoa = frame:FindFirstChild(gemID)
			if nutCanXoa then nutCanXoa:Destroy() end
		end
	end
end)
