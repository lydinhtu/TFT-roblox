local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SuKienDiChuyen = ReplicatedStorage:WaitForChild("SuKienDiChuyen")
local DangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")
local workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local KICH_THUOC_O = 6 
local folderHangCho = workspace:WaitForChild("HangCho")

-- 1. H√†m t√≠nh t√¢m √¥ (D√†nh cho s√†n ƒë·∫•u)
local function LayTamO(position, yPos)
	local nuaO = KICH_THUOC_O / 2
	local x = (math.floor(position.X / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	local z = (math.floor(position.Z / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	return Vector3.new(x, yPos, z)
end

-- 2. H√†m ki·ªÉm tra √¥ tr·ªëng (Quan tr·ªçng ƒë·ªÉ kh√¥ng b·ªã ch·ªìng)
local function KiemTraOTrong(viTriDich, unitDangDiChuyen)
	for _, v in pairs(workspace:GetChildren()) do
		-- B·ªè qua ch√≠nh b·∫£n th√¢n con l√≠nh ƒëang di chuy·ªÉn
		if v == unitDangDiChuyen then continue end

		-- B·ªè qua ng∆∞·ªùi ch∆°i (Player) ƒë·ªÉ kh√¥ng b·ªã k·∫πt b·ªüi ch√≠nh b·∫°n
		if Players:GetPlayerFromCharacter(v) then continue end

		-- Ki·ªÉm tra xem c√≥ l√≠nh n√†o kh√°c ƒë·ª©ng ƒë√≥ kh√¥ng
		if v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
			local posLinh = v.HumanoidRootPart.Position * Vector3.new(1, 0, 1)
			local posDich = viTriDich * Vector3.new(1, 0, 1)

			-- N·∫øu kho·∫£ng c√°ch < 1.5 m√©t -> ƒê√£ c√≥ ng∆∞·ªùi ƒë·ª©ng
			if (posLinh - posDich).Magnitude < 1.5 then
				return false -- KH√îNG TR·ªêNG
			end
		end
	end
	return true -- TR·ªêNG
end

-- 3. X·ª≠ l√Ω s·ª± ki·ªán di chuy·ªÉn
SuKienDiChuyen.OnServerEvent:Connect(function(player, unit, clickPosition)
	-- N·∫øu ƒëang ƒë√°nh nhau th√¨ c·∫•m di chuy·ªÉn
	if DangDanhNhau.Value == true then 
		warn("‚õî ƒêang chi·∫øn ƒë·∫•u, kh√¥ng th·ªÉ di chuy·ªÉn!")
		return 
	end

	if not unit or not unit:FindFirstChild("HumanoidRootPart") then return end

	local rootPart = unit.HumanoidRootPart
	local humanoid = unit:FindFirstChild("Humanoid")

	-- L∆∞u v·ªã tr√≠ c≈© (ƒê·ªÉ l·ª° c√≥ l·ªói th√¨ c√≤n bi·∫øt n√≥ ·ªü ƒë√¢u - d√π logic d∆∞·ªõi ƒë√¢y l√† kh√¥ng di chuy·ªÉn lu√¥n)
	local viTriCu = rootPart.CFrame

	local viTriDich = nil
	local trangThaiRaTran = true -- M·∫∑c ƒë·ªãnh l√† ra tr·∫≠n

	-- A. KI·ªÇM TRA XEM C√ì K√âO V√ÄO H√ÄNG CH·ªú KH√îNG?
	local khoangCachNganNhat = 5
	local slotGanNhat = nil

	for _, slot in pairs(folderHangCho:GetChildren()) do
		if slot:IsA("BasePart") then
			local dist = (slot.Position - clickPosition).Magnitude
			if dist < khoangCachNganNhat then
				khoangCachNganNhat = dist
				slotGanNhat = slot
			end
		end
	end

	if slotGanNhat then
		-- >>> TR∆Ø·ªúNG H·ª¢P 1: V√ÄO H√ÄNG CH·ªú <<<
		local viTriDuKien = slotGanNhat.Position + Vector3.new(0, 3, 0)

		-- Ki·ªÉm tra xem Slot n√†y c√≥ ai ƒë·ª©ng ch∆∞a?
		if KiemTraOTrong(viTriDuKien, unit) then
			viTriDich = viTriDuKien
			trangThaiRaTran = false -- V·ªÅ h√†ng ch·ªù ngh·ªâ ng∆°i
			print("‚úÖ Chuy·ªÉn v·ªÅ h√†ng ch·ªù: " .. slotGanNhat.Name)
		else
			warn("‚ùå √î h√†ng ch·ªù ƒë√£ c√≥ ng∆∞·ªùi! H·ªßy di chuy·ªÉn.")
			return -- D·ª™NG L·∫†I NGAY (L√≠nh s·∫Ω ƒë·ª©ng y√™n t·∫°i ch·ªó c≈©)
		end
	else
		-- >>> TR∆Ø·ªúNG H·ª¢P 2: RA S√ÄN ƒê·∫§U <<<
		local viTriDuKien = LayTamO(clickPosition, rootPart.Position.Y + 3)

		-- Ki·ªÉm tra xem √¥ tr√™n b√†n c·ªù c√≥ ai ƒë·ª©ng ch∆∞a?
		if KiemTraOTrong(viTriDuKien, unit) then
			viTriDich = viTriDuKien
			trangThaiRaTran = true -- Ra tr·∫≠n
		else
			warn("‚ùå √î tr√™n s√†n ƒë·∫•u ƒë√£ c√≥ ng∆∞·ªùi! H·ªßy di chuy·ªÉn.")
			return -- D·ª™NG L·∫†I NGAY
		end
	end

	-- B. TH·ª∞C HI·ªÜN DI CHUY·ªÇN (Ch·ªâ ch·∫°y xu·ªëng ƒë√¢y n·∫øu c√°c b∆∞·ªõc tr√™n ƒë·ªÅu OK)
	if viTriDich then
		rootPart.Anchored = false
		rootPart.CFrame = CFrame.new(viTriDich) * rootPart.CFrame.Rotation

		if humanoid then
			humanoid:MoveTo(rootPart.Position)
		end

		unit:SetAttribute("DaRaTran", trangThaiRaTran)
		print("üöÄ Di chuy·ªÉn th√†nh c√¥ng!")
	end
end)
