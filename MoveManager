local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SuKienDiChuyen = ReplicatedStorage:WaitForChild("SuKienDiChuyen")
local DangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")

-- C·∫§U H√åNH
local KICH_THUOC_O = 6 

-- H√†m t√≠nh to√°n t√¢m √¥ vu√¥ng
local function LayTamO(position, yPos)
	local nuaO = KICH_THUOC_O / 2
	local x = (math.floor(position.X / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	local z = (math.floor(position.Z / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	return Vector3.new(x, yPos, z)
end

-- L·∫ÆNG NGHE Y√äU C·∫¶U DI CHUY·ªÇN T·ª™ NG∆Ø·ªúI CH∆†I
SuKienDiChuyen.OnServerEvent:Connect(function(player, unit, position)
	print("üì© Server nh·∫≠n l·ªánh d·ªùi qu√¢n t·ª´: " .. player.Name)

	-- 1. Ki·ªÉm tra: N·∫øu ƒëang ƒë√°nh nhau th√¨ C·∫§M di chuy·ªÉn
	if DangDanhNhau.Value == true then 
		warn("‚õî Server t·ª´ ch·ªëi: ƒêang trong tr·∫≠n chi·∫øn!")
		return 
	end

	-- 2. Ki·ªÉm tra con l√≠nh c√≥ h·ª£p l·ªá kh√¥ng
	if not unit or not unit:FindFirstChild("HumanoidRootPart") then return end

	local rootPart = unit.HumanoidRootPart
	local humanoid = unit:FindFirstChild("Humanoid")

	-- 3. T√≠nh to√°n v·ªã tr√≠ m·ªõi
	-- C·ªông th√™m 3 ƒë∆°n v·ªã chi·ªÅu cao (Y) ƒë·ªÉ th·∫£ n√≥ r∆°i xu·ªëng s√†n, tr√°nh b·ªã k·∫πt n·ª≠a ng∆∞·ªùi
	local viTriMoi = LayTamO(position, rootPart.Position.Y + 3)

	-- 4. TH·ª∞C HI·ªÜN DI CHUY·ªÇN
	-- [Quan Tr·ªçng] Ph·∫£i nh·ªï neo (Anchored = false) tr∆∞·ªõc khi di chuy·ªÉn
	rootPart.Anchored = false

	-- D·ªãch chuy·ªÉn t·ª©c th·ªùi t·ªõi √¥ m·ªõi
	rootPart.CFrame = CFrame.new(viTriMoi) * rootPart.CFrame.Rotation

	-- Reset ƒë∆∞·ªùng ƒëi c·ªßa Humanoid ƒë·ªÉ n√≥ ƒë·ª©ng y√™n t·∫°i ch·ªó m·ªõi
	if humanoid then
		humanoid:MoveTo(rootPart.Position)
	end

	print("‚úÖ ƒê√£ d·ªãch chuy·ªÉn " .. unit.Name .. " th√†nh c√¥ng!")
end)
