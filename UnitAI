local UnitAI = {}

-- === C·∫§U H√åNH ===
local KICH_THUOC_O = 6 
local DO_CAO_NGHIA_DIA = 150 
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local bienDangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau", 10)
local workspace = game:GetService("Workspace")
local ServerStorage = game:GetService("ServerStorage") -- [QUAN TR·ªåNG] Ph·∫£i c√≥ d√≤ng n√†y
local GemConfig = require(game.ReplicatedStorage:WaitForChild("GemConfig"))

local folderDatCho = workspace:FindFirstChild("DatCho") or Instance.new("Folder", workspace)
if folderDatCho.Name ~= "DatCho" then folderDatCho.Name = "DatCho" end

local function LayTamO(position, yPos)
	local nuaO = KICH_THUOC_O / 2
	local x = (math.floor(position.X / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	local z = (math.floor(position.Z / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	return Vector3.new(x, yPos, z)
end

local function QuetToanBoDonVi(action)
	for _, v in pairs(workspace:GetChildren()) do action(v) end
	local folder = workspace:FindFirstChild("LivingEnemies")
	if folder then for _, v in pairs(folder:GetChildren()) do action(v) end end
end

local function KiemTraOTrong(viTri, npcIgnore)
	local posO = Vector3.new(viTri.X, 0, viTri.Z)
	local isTrong = true
	QuetToanBoDonVi(function(v)
		if not isTrong then return end 
		if v:IsA("Model") and v ~= npcIgnore and v:GetAttribute("DaChet") ~= true then
			local root = v:FindFirstChild("HumanoidRootPart")
			if root then
				local posVatCan = Vector3.new(root.Position.X, 0, root.Position.Z)
				if root.Position.Y < 50 and (posVatCan - posO).Magnitude < 2.5 then isTrong = false end
			end
		end
	end)
	if not isTrong then return false end
	for _, gach in pairs(folderDatCho:GetChildren()) do
		local posGach = Vector3.new(gach.Position.X, 0, gach.Position.Z)
		if (posGach - posO).Magnitude < 1 then return false end
	end
	return true 
end

local function DatChoVaDiChuyen(npc, viTriMuonDen)
	local gachMoi = Instance.new("Part")
	gachMoi.Name = "GachCua_" .. npc.Name
	gachMoi.Size = Vector3.new(1, 1, 1)
	gachMoi.Position = viTriMuonDen
	gachMoi.Anchored = true
	gachMoi.CanCollide = false 
	gachMoi.Transparency = 1 
	gachMoi.Parent = folderDatCho
	game:GetService("Debris"):AddItem(gachMoi, 2)
	return gachMoi
end

local function DonDepSachSe(npc)
	for _, gach in pairs(folderDatCho:GetChildren()) do
		if gach.Name == "GachCua_" .. npc.Name then gach:Destroy() end
	end
end

-- === LOGIC CH√çNH ===
function UnitAI.KhoiTao(npc, config)
	local humanoid = npc:WaitForChild("Humanoid")
	local rootPart = npc:WaitForChild("HumanoidRootPart")
	local stats = humanoid:WaitForChild("Stats")

	if rootPart:CanSetNetworkOwnership() then rootPart:SetNetworkOwner(nil) end

	humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
	humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
	humanoid:SetStateEnabled(Enum.HumanoidStateType.Dead, false) 
	humanoid.BreakJointsOnDeath = false 

	local statsTamDanh = stats:WaitForChild("TamDanh")
	local statsSatThuong = stats:WaitForChild("SatThuong")
	local statsTocDoDanh = stats:WaitForChild("TocDoDanh")
	local statsTocDoDiChuyen = stats:WaitForChild("TocDoDiChuyen")
	local myTeam = stats:WaitForChild("Team").Value

	local animObj = Instance.new("Animation")
	animObj.AnimationId = config.AnimationID or "rbxassetid://507777826"
	local attackTrack = humanoid:LoadAnimation(animObj)

	local daChet = false
	local viTriNha = rootPart.Position
	local dangDanhNhauTruocDo = false

	humanoid.HealthChanged:Connect(function(hp)
		if hp <= 0 and not daChet then
			if myTeam == "Enemy" then

				-- >>> [ƒêO·∫†N CODE B·∫†N B·ªä THI·∫æU] <<<
				-- B√°o tin qu√°i ch·∫øt cho GemSystem
				local bindable = ServerStorage:FindFirstChild("EnemyDiedEvent")
				if bindable then
					-- T√¨m ng∆∞·ªùi ch∆°i ƒë·ªÉ t·∫∑ng ng·ªçc (L·∫•y ng∆∞·ªùi ch∆°i ƒë·∫ßu ti√™n trong server)
					local player = game.Players:GetPlayers()[1]
					if player then
						print("üíÄ Qu√°i ch·∫øt! G·ª≠i t√≠n hi·ªáu r·ªõt ƒë·ªì...")
						bindable:Fire(player)
					end
				else
					warn("‚ö†Ô∏è L·ªói: Kh√¥ng t√¨m th·∫•y EnemyDiedEvent trong ServerStorage!")
				end
				-- >>> K·∫æT TH√öC ƒêO·∫†N THI·∫æU <<<

				daChet = true
				DonDepSachSe(npc)
				npc:Destroy()
			else
				-- L√≠nh ta ch·∫øt gi·∫£
				daChet = true
				npc:SetAttribute("DaChet", true)
				humanoid.Health = 1
				humanoid.WalkSpeed = 0
				if attackTrack then attackTrack:Stop() end
				rootPart.Anchored = true
				rootPart.CFrame = rootPart.CFrame + Vector3.new(0, DO_CAO_NGHIA_DIA, 0)
				rootPart.AssemblyLinearVelocity = Vector3.new(0,0,0)
				for _, v in pairs(npc:GetChildren()) do
					if v:IsA("BasePart") and v.Name ~= "HumanoidRootPart" then
						v.Transparency = 0.5
						v.CastShadow = false
					elseif v:IsA("BillboardGui") then v.Enabled = false end
				end
				for _, v in pairs(npc:GetDescendants()) do
					if v:IsA("BasePart") then v.CanCollide = false end
				end
				DonDepSachSe(npc)
			end
		end
	end)

	task.spawn(function()
		while npc.Parent do
			task.wait(0.1)
			local dangDanhNhau = bienDangDanhNhau.Value

			if daChet then
				if humanoid.Health < 1 then humanoid.Health = 1 end
				if not dangDanhNhau then
					daChet = false
					npc:SetAttribute("DaChet", nil)
					rootPart.CFrame = CFrame.new(viTriNha + Vector3.new(0, 3, 0)) * rootPart.CFrame.Rotation
					rootPart.AssemblyLinearVelocity = Vector3.new(0,0,0)
					task.wait() 
					humanoid.Health = humanoid.MaxHealth
					for _, v in pairs(npc:GetChildren()) do
						if v:IsA("BasePart") and v.Name ~= "HumanoidRootPart" then
							v.Transparency = 0
							v.CastShadow = true
						elseif v:IsA("BillboardGui") then v.Enabled = true end
					end
					for _, v in pairs(npc:GetDescendants()) do
						if v:IsA("BasePart") then v.CanCollide = true end
					end
					rootPart.Anchored = false 
					dangDanhNhauTruocDo = dangDanhNhau
				end
				continue 
			end

			if not dangDanhNhau then
				humanoid.WalkSpeed = 0
				rootPart.Anchored = false
				DonDepSachSe(npc)
				if humanoid.Health < humanoid.MaxHealth then humanoid.Health = humanoid.MaxHealth end
				if dangDanhNhauTruocDo then 
					rootPart.CFrame = CFrame.new(viTriNha + Vector3.new(0, 3, 0)) * rootPart.CFrame.Rotation
					rootPart.AssemblyLinearVelocity = Vector3.new(0,0,0)
				else 
					if rootPart.Position.Y < 5 and rootPart.AssemblyLinearVelocity.Magnitude < 0.1 then 
						viTriNha = rootPart.Position 
					end
				end
				dangDanhNhauTruocDo = dangDanhNhau
				continue
			end
			dangDanhNhauTruocDo = dangDanhNhau

			if npc:GetAttribute("DaRaTran") then
				local mucTieu = nil
				local minDst = math.huge
				QuetToanBoDonVi(function(v)
					if v:IsA("Model") and v ~= npc and v:GetAttribute("DaChet") ~= true then
						local h = v:FindFirstChild("Humanoid")
						if h and h.Health > 0 then
							local eStats = h:FindFirstChild("Stats")
							if eStats and eStats:FindFirstChild("Team") and eStats.Team.Value ~= myTeam then
								local dist = (rootPart.Position - v.HumanoidRootPart.Position).Magnitude
								if dist < minDst then 
									minDst = dist
									mucTieu = v.HumanoidRootPart 
								end
							end
						end
					end
				end)

				if mucTieu then
					local tamDanhThucTe = math.max(statsTamDanh.Value, KICH_THUOC_O - 1)
					local dist = (rootPart.Position - mucTieu.Position).Magnitude
					if dist <= tamDanhThucTe then
						-- 1. XOAY & ANIMATION
						local lookPos = Vector3.new(mucTieu.Position.X, rootPart.Position.Y, mucTieu.Position.Z)
						rootPart.CFrame = CFrame.lookAt(rootPart.Position, lookPos)
						humanoid.WalkSpeed = 0
						DonDepSachSe(npc)
						attackTrack:Play()
						task.wait(0.3) -- ƒê·ª£i vung tay

						-- 2. ƒê·ªåC 2 SLOT NG·ªåC (CH√çNH + H·ªñ TR·ª¢)
						local gemMainID = npc:GetAttribute("GemMain")
						local gemSupportID = npc:GetAttribute("GemSupport")

						local mainInfo = GemConfig[gemMainID]
						local supportInfo = GemConfig[gemSupportID]

						local daDungSkill = false

						-- Ch·ªâ d√πng skill n·∫øu c√≥ Ng·ªçc Ch√≠nh (Active)
						if gemMainID and mainInfo and mainInfo.Type == "Active" then
							daDungSkill = true

							-- L·∫•y ch·ªâ s·ªë g·ªëc
							local damagePercent = mainInfo.DamagePercent or 1
							local cooldown = mainInfo.Cooldown or 1.5

							-- C·ªông h∆∞·ªüng t·ª´ Ng·ªçc H·ªó Tr·ª£ (N·∫øu c√≥)
							if gemSupportID and supportInfo and supportInfo.Type == "Support" then
								print("‚ú® K√≠ch ho·∫°t H·ªó Tr·ª£: " .. supportInfo.Name)
								if supportInfo.BuffDamage then
									damagePercent = damagePercent + supportInfo.BuffDamage
								end
								if supportInfo.BuffCooldown then
									cooldown = cooldown * (1 - supportInfo.BuffCooldown)
								end
							end

							-- T√≠nh Damage cu·ªëi
							local finalDamage = statsSatThuong.Value * damagePercent
							print("üî• Skill: " .. mainInfo.Name .. " | Dmg: " .. finalDamage)

							-- [THI TRI·ªÇN C·∫¶U L·ª¨A]
							if gemMainID == "CauLua" then
								local ball = Instance.new("Part")
								ball.Shape = "Ball"
								ball.Size = Vector3.new(2,2,2)
								ball.Color = mainInfo.Color
								ball.Material = "Neon"
								ball.CanCollide = false
								ball.Position = rootPart.Position + Vector3.new(0, 2, 0)
								ball.Parent = workspace

								local tween = TweenService:Create(ball, TweenInfo.new(0.5), {Position = mucTieu.Position})
								tween:Play()

								tween.Completed:Connect(function()
									ball:Destroy()
									local eff = Instance.new("Explosion")
									eff.Position = mucTieu.Position
									eff.BlastRadius = 0 
									eff.Parent = workspace

									if mucTieu.Parent and mucTieu.Parent:FindFirstChild("Humanoid") then
										mucTieu.Parent.Humanoid:TakeDamage(finalDamage)
									end
								end)

								-- [THI TRI·ªÇN BƒÇNG GI√Å]
							elseif gemMainID == "BangGia" then
								if mucTieu.Parent and mucTieu.Parent:FindFirstChild("Humanoid") then
									mucTieu.Parent.Humanoid:TakeDamage(finalDamage)
									mucTieu.Parent.Humanoid.WalkSpeed = 8 -- L√†m ch·∫≠m
								end
							end

							-- H·ªìi chi√™u (theo ng·ªçc)
							task.wait(cooldown)
						else
							-- Kh√¥ng c√≥ ng·ªçc -> ƒê√°nh th∆∞·ªùng
							if config.KyNangTanCong then
								config.KyNangTanCong(npc, mucTieu, statsSatThuong.Value)
							else
								if mucTieu.Parent and mucTieu.Parent:FindFirstChild("Humanoid") then
									mucTieu.Parent.Humanoid:TakeDamage(statsSatThuong.Value)
								end
							end
							-- H·ªìi chi√™u th∆∞·ªùng
							task.wait(math.max(0.1, (1 / statsTocDoDanh.Value) - 0.3))
						end

					else
						humanoid.WalkSpeed = statsTocDoDiChuyen.Value
						local tamO_HienTai = LayTamO(rootPart.Position, rootPart.Position.Y)
						local oTotNhat = nil
						local kcMin = math.huge
						local cacHuong = {Vector3.new(KICH_THUOC_O, 0, 0), Vector3.new(-KICH_THUOC_O, 0, 0), Vector3.new(0, 0, KICH_THUOC_O), Vector3.new(0, 0, -KICH_THUOC_O)}
						for _, huong in ipairs(cacHuong) do
							local oThu = tamO_HienTai + huong
							if KiemTraOTrong(oThu, npc) then
								local d = (oThu - mucTieu.Position).Magnitude
								if d < kcMin then 
									kcMin = d
									oTotNhat = oThu 
								end
							end
						end
						if oTotNhat then
							local cucGach = DatChoVaDiChuyen(npc, oTotNhat)
							humanoid:MoveTo(oTotNhat)
							local timeOut = 0
							while timeOut < 20 do
								task.wait(0.05)
								timeOut = timeOut + 1
								local distToTarget = (Vector3.new(rootPart.Position.X, 0, rootPart.Position.Z) - Vector3.new(oTotNhat.X, 0, oTotNhat.Z)).Magnitude
								if distToTarget < 0.5 then break end 
							end
							if cucGach then cucGach:Destroy() end
						else
							humanoid:MoveTo(rootPart.Position)
							task.wait(0.1)
						end
					end
				else
					humanoid:MoveTo(rootPart.Position)
				end
			else
				humanoid.WalkSpeed = 0
				rootPart.Anchored = true
			end
		end
	end)
end

return UnitAI
