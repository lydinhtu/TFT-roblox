-- File: ServerScriptService/GemSystem
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- [QUAN TR·ªåNG] Ki·ªÉm tra xem file GemConfig c√≥ t·ªìn t·∫°i kh√¥ng
local gemConfigModule = ReplicatedStorage:FindFirstChild("GemConfig")
if not gemConfigModule then
	warn("‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y Module 'GemConfig' trong ReplicatedStorage!")
	return -- D·ª´ng script l·∫°i n·∫øu thi·∫øu Config
end

local GemConfig = require(gemConfigModule)

-- 1. T·∫†O REMOTE EVENT (ƒê·ªÉ g·ª≠i tin cho Client v·∫Ω UI)
local remoteGemDrop = ReplicatedStorage:FindFirstChild("SuKienNhatGem") or Instance.new("RemoteEvent")
remoteGemDrop.Name = "SuKienNhatGem"
remoteGemDrop.Parent = ReplicatedStorage

-- 2. T·∫†O BINDABLE EVENT (ƒê·ªÉ UnitAI g·ªçi sang)
local bindable = ServerStorage:FindFirstChild("EnemyDiedEvent") or Instance.new("BindableEvent")
bindable.Name = "EnemyDiedEvent"
bindable.Parent = ServerStorage

print("‚úÖ GemSystem ƒë√£ kh·ªüi ƒë·ªông! ƒê√£ t·∫°o EnemyDiedEvent.")


local DROP_CHANCE = 0.5 

-- 3. X·ª¨ L√ù KHI NH·∫¨N ƒê∆Ø·ª¢C TIN QU√ÅI CH·∫æT
bindable.Event:Connect(function(player)
	print("üíé GemSystem: Nh·∫≠n ƒë∆∞·ª£c tin qu√°i ch·∫øt t·ª´ " .. player.Name)

	if math.random() <= DROP_CHANCE then
		-- L·∫•y danh s√°ch t·∫•t c·∫£ Gem t·ª´ Config
		local list = {}
		for id, _ in pairs(GemConfig) do
			table.insert(list, id)
		end

		if #list > 0 then
			-- Ch·ªçn b·ª´a 1 vi√™n
			local gemID = list[math.random(1, #list)]
			print("üé≤ ƒê√£ random ra ng·ªçc: " .. gemID .. " -> G·ª≠i cho Client...")

			-- G·ª≠i v·ªÅ cho ng∆∞·ªùi ch∆°i
			remoteGemDrop:FireClient(player, gemID)
		else
			warn("‚ö†Ô∏è GemConfig ƒëang r·ªóng! H√£y th√™m ng·ªçc v√†o file Config.")
		end
	else
		print("‚ùå Kh√¥ng r·ªõt ƒë·ªì (Do t·ª∑ l·ªá)")
	end
end)
-- ... (Gi·ªØ nguy√™n code c≈© c·ªßa GemSystem ·ªü tr√™n)

-- [M·ªöI] T·∫†O S·ª∞ KI·ªÜN TRANG B·ªä
local remoteEquip = ReplicatedStorage:FindFirstChild("SuKienTrangBiGem") or Instance.new("RemoteEvent")
remoteEquip.Name = "SuKienTrangBiGem"
remoteEquip.Parent = ReplicatedStorage

-- X·ª¨ L√ù KHI NG∆Ø·ªúI CH∆†I L·∫ÆP NG·ªåC
remoteEquip.OnServerEvent:Connect(function(player, gemID, unitModel)
	if not unitModel or not unitModel:FindFirstChild("Humanoid") then return end

	-- Ki·ªÉm tra xem l√≠nh c√≥ thu·ªôc v·ªÅ ng∆∞·ªùi ch∆°i kh√¥ng (tr√°nh hack)
	local chuSoHuu = unitModel:GetAttribute("ChuSoHuu")
	-- (N·∫øu game b·∫°n ch∆∞a set Attribute ChuSoHuu th√¨ t·∫°m b·ªè qua d√≤ng n√†y)

	print("‚úÖ Server: ƒê√£ l·∫Øp ng·ªçc " .. gemID .. " cho " .. unitModel.Name)

	-- G·∫ÆN M√ÅC NG·ªåC V√ÄO L√çNH
	-- UnitAI s·∫Ω ƒë·ªçc c√°i n√†y ƒë·ªÉ bi·∫øt l√≠nh ƒëang d√πng chi√™u g√¨
	unitModel:SetAttribute("GemID", gemID)

	-- [HI·ªÜU ·ª®NG] T·∫°o v√≤ng s√°ng b√°o hi·ªáu th√†nh c√¥ng
	local highlight = Instance.new("Highlight")
	highlight.FillColor = Color3.fromRGB(255, 255, 255)
	highlight.OutlineColor = GemConfig[gemID].Color
	highlight.Parent = unitModel

	game.Debris:AddItem(highlight, 0.5) -- X√≥a hi·ªáu ·ª©ng sau 0.5s
end)
-- ... (Ph·∫ßn tr√™n c·ªßa GemSystem gi·ªØ nguy√™n) ...

local remoteEquip = ReplicatedStorage:FindFirstChild("SuKienTrangBiGem") or Instance.new("RemoteEvent")
remoteEquip.Name = "SuKienTrangBiGem"
remoteEquip.Parent = ReplicatedStorage

-- X·ª¨ L√ù L·∫ÆP NG·ªåC TH√îNG MINH
remoteEquip.OnServerEvent:Connect(function(player, gemID, unitModel)
	if not unitModel or not unitModel:FindFirstChild("Humanoid") then return end

	local gemInfo = GemConfig[gemID]
	if not gemInfo then return end

	-- L·∫•y t√™n g·ªëc c·ªßa t∆∞·ªõng (ƒë√£ ƒë∆∞·ª£c ShopManager set l√∫c mua)
	local tenUnitGoc = unitModel:GetAttribute("TenUnit") -- V√≠ d·ª•: "LinhTa1", "LinhTa2"

	-- 1. KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN T∆Ø·ªöNG (Cho ng·ªçc Active)
	if gemInfo.AllowedUnits then
		local duocPhep = false
		for _, u in pairs(gemInfo.AllowedUnits) do
			if u == tenUnitGoc then 
				duocPhep = true 
				break
			end
		end

		if not duocPhep then
			warn("‚õî Ng·ªçc n√†y kh√¥ng d√†nh cho " .. (tenUnitGoc or "Unit n√†y") .. "!")
			return -- D·ª´ng l·∫°i, kh√¥ng cho l·∫Øp
		end
	end

	-- 2. X·ª¨ L√ù THEO LO·∫†I NG·ªåC
	if gemInfo.Type == "Active" then
		-- L·∫Øp v√†o slot Ch√≠nh
		unitModel:SetAttribute("GemMain", gemID)
		print("‚úÖ ƒê√£ l·∫Øp Skill Ch√≠nh: " .. gemInfo.Name)

	elseif gemInfo.Type == "Support" then
		-- Ki·ªÉm tra xem c√≥ Skill Ch√≠nh ch∆∞a
		if unitModel:GetAttribute("GemMain") then
			-- L·∫Øp v√†o slot H·ªó Tr·ª£
			unitModel:SetAttribute("GemSupport", gemID)
			print("‚úÖ ƒê√£ l·∫Øp H·ªó Tr·ª£: " .. gemInfo.Name)
		else
			warn("‚õî Ph·∫£i c√≥ ng·ªçc K·ªπ NƒÉng tr∆∞·ªõc m·ªõi ƒë∆∞·ª£c l·∫Øp ng·ªçc H·ªó Tr·ª£!")
			return -- D·ª´ng l·∫°i
		end
	end

	-- Hi·ªáu ·ª©ng th√†nh c√¥ng
	local highlight = Instance.new("Highlight")
	highlight.FillColor = Color3.fromRGB(255, 255, 255)
	highlight.OutlineColor = gemInfo.Color
	highlight.Parent = unitModel
	game.Debris:AddItem(highlight, 0.5)
end)
