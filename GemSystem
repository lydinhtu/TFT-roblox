-- File: ServerScriptService/GemSystem
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- Kiểm tra Config
local gemConfigModule = ReplicatedStorage:FindFirstChild("GemConfig")
if not gemConfigModule then return end
local GemConfig = require(gemConfigModule)

-- 1. TẠO CÁC EVENT
local remoteGemDrop = ReplicatedStorage:FindFirstChild("SuKienNhatGem") or Instance.new("RemoteEvent")
remoteGemDrop.Name = "SuKienNhatGem"
remoteGemDrop.Parent = ReplicatedStorage

local remoteEquip = ReplicatedStorage:FindFirstChild("SuKienTrangBiGem") or Instance.new("RemoteEvent")
remoteEquip.Name = "SuKienTrangBiGem"
remoteEquip.Parent = ReplicatedStorage

local bindable = ServerStorage:FindFirstChild("EnemyDiedEvent") or Instance.new("BindableEvent")
bindable.Name = "EnemyDiedEvent"
bindable.Parent = ServerStorage

local DROP_CHANCE = 0.5 

-- 2. XỬ LÝ RỚT ĐỒ
bindable.Event:Connect(function(player)
	if math.random() <= DROP_CHANCE then
		local list = {}
		for id, _ in pairs(GemConfig) do table.insert(list, id) end

		if #list > 0 then
			local gemID = list[math.random(1, #list)]
			remoteGemDrop:FireClient(player, gemID)
		end
	end
end)

-- 3. XỬ LÝ LẮP TRANG BỊ
remoteEquip.OnServerEvent:Connect(function(player, gemID, unitModel)
	if not unitModel or not unitModel:FindFirstChild("Humanoid") then return end

	local gemInfo = GemConfig[gemID]
	if not gemInfo then return end

	local tenUnitGoc = unitModel:GetAttribute("TenUnit")
	local success = false -- Biến đánh dấu thành công

	-- A. KIỂM TRA ĐIỀU KIỆN
	if gemInfo.AllowedUnits then
		local duocPhep = false
		for _, u in pairs(gemInfo.AllowedUnits) do
			if u == tenUnitGoc then duocPhep = true break end
		end

		if not duocPhep then
			warn("⛔ Ngọc không phù hợp!")
			return -- Không làm gì cả (Client sẽ không nhận được tin success)
		end
	end

	-- B. XỬ LÝ LẮP
	if gemInfo.Type == "Active" then
		unitModel:SetAttribute("GemMain", gemID)
		print("✅ Đã lắp Skill Chính")
		success = true

	elseif gemInfo.Type == "Support" then
		if unitModel:GetAttribute("GemMain") then
			unitModel:SetAttribute("GemSupport", gemID)
			print("✅ Đã lắp Hỗ Trợ")
			success = true
		else
			warn("⛔ Cần có Ngọc Kỹ Năng trước!")
			return
		end
	end

	-- C. [QUAN TRỌNG] NẾU THÀNH CÔNG -> BÁO LẠI CHO CLIENT XÓA NGỌC
	if success then
		-- Gửi tin nhắn về cho đúng người chơi đó, kèm theo ID ngọc đã lắp
		-- Chúng ta dùng lại RemoteEvent này, nhưng chiều ngược lại (Server -> Client)
		remoteEquip:FireClient(player, gemID, true) 

		-- Hiệu ứng
		local highlight = Instance.new("Highlight")
		highlight.FillColor = Color3.fromRGB(255, 255, 255)
		highlight.OutlineColor = gemInfo.Color
		highlight.Parent = unitModel
		game.Debris:AddItem(highlight, 0.5)
	end
end)
