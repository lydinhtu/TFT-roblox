-- File: ServerScriptService/GemSystem
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- Kiểm tra Config
local gemConfigModule = ReplicatedStorage:FindFirstChild("GemConfig")
if not gemConfigModule then
	warn("❌ Lỗi: Không tìm thấy Module 'GemConfig' trong ReplicatedStorage!")
	return 
end
local GemConfig = require(gemConfigModule)

-- 1. TẠO CÁC EVENT
local remoteGemDrop = ReplicatedStorage:FindFirstChild("SuKienNhatGem") or Instance.new("RemoteEvent")
remoteGemDrop.Name = "SuKienNhatGem"
remoteGemDrop.Parent = ReplicatedStorage

local remoteEquip = ReplicatedStorage:FindFirstChild("SuKienTrangBiGem") or Instance.new("RemoteEvent")
remoteEquip.Name = "SuKienTrangBiGem"
remoteEquip.Parent = ReplicatedStorage

local bindable = ServerStorage:FindFirstChild("EnemyDiedEvent") or Instance.new("BindableEvent")
bindable.Name = "EnemyDiedEvent"
bindable.Parent = ServerStorage

print("✅ GemSystem đã khởi động!")

-- 2. XỬ LÝ RỚT ĐỒ
local DROP_CHANCE = 0.5 
bindable.Event:Connect(function(player)
	if math.random() <= DROP_CHANCE then
		local list = {}
		for id, _ in pairs(GemConfig) do table.insert(list, id) end

		if #list > 0 then
			local gemID = list[math.random(1, #list)]
			remoteGemDrop:FireClient(player, gemID)
		end
	end
end)

-- 3. XỬ LÝ LẮP TRANG BỊ (LOGIC MỚI CỦA BẠN)
remoteEquip.OnServerEvent:Connect(function(player, gemID, unitModel)
	if not unitModel or not unitModel:FindFirstChild("Humanoid") then return end

	local gemInfo = GemConfig[gemID]
	if not gemInfo then return end

	local tenUnitGoc = unitModel:GetAttribute("TenUnit")

	-- A. KIỂM TRA ĐIỀU KIỆN TƯỚNG (AllowedUnits)
	if gemInfo.AllowedUnits then
		local duocPhep = false
		for _, u in pairs(gemInfo.AllowedUnits) do
			if u == tenUnitGoc then 
				duocPhep = true 
				break
			end
		end

		if not duocPhep then
			warn("⛔ Ngọc " .. gemInfo.Name .. " không dành cho " .. (tenUnitGoc or "Unit này") .. "!")
			return 
		end
	end

	-- B. XỬ LÝ THEO LOẠI NGỌC
	if gemInfo.Type == "Active" then
		unitModel:SetAttribute("GemMain", gemID) -- Gắn vào slot Chính
		print("✅ Đã lắp Skill Chính: " .. gemInfo.Name)

	elseif gemInfo.Type == "Support" then
		if unitModel:GetAttribute("GemMain") then
			unitModel:SetAttribute("GemSupport", gemID) -- Gắn vào slot Hỗ Trợ
			print("✅ Đã lắp Hỗ Trợ: " .. gemInfo.Name)
		else
			warn("⛔ Cần có Ngọc Kỹ Năng trước mới được lắp Ngọc Hỗ Trợ!")
			return 
		end
	end

	-- Hiệu ứng
	local highlight = Instance.new("Highlight")
	highlight.FillColor = Color3.fromRGB(255, 255, 255)
	highlight.OutlineColor = gemInfo.Color
	highlight.Parent = unitModel
	game.Debris:AddItem(highlight, 0.5)
end)
