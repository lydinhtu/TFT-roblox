-- File: ServerScriptService/GemSystem
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- [QUAN TR·ªåNG] Ki·ªÉm tra xem file GemConfig c√≥ t·ªìn t·∫°i kh√¥ng
local gemConfigModule = ReplicatedStorage:FindFirstChild("GemConfig")
if not gemConfigModule then
	warn("‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y Module 'GemConfig' trong ReplicatedStorage!")
	return -- D·ª´ng script l·∫°i n·∫øu thi·∫øu Config
end

local GemConfig = require(gemConfigModule)

-- 1. T·∫†O REMOTE EVENT (ƒê·ªÉ g·ª≠i tin cho Client v·∫Ω UI)
local remoteGemDrop = ReplicatedStorage:FindFirstChild("SuKienNhatGem") or Instance.new("RemoteEvent")
remoteGemDrop.Name = "SuKienNhatGem"
remoteGemDrop.Parent = ReplicatedStorage

-- 2. T·∫†O BINDABLE EVENT (ƒê·ªÉ UnitAI g·ªçi sang)
local bindable = ServerStorage:FindFirstChild("EnemyDiedEvent") or Instance.new("BindableEvent")
bindable.Name = "EnemyDiedEvent"
bindable.Parent = ServerStorage

print("‚úÖ GemSystem ƒë√£ kh·ªüi ƒë·ªông! ƒê√£ t·∫°o EnemyDiedEvent.")


local DROP_CHANCE = 0.5 

-- 3. X·ª¨ L√ù KHI NH·∫¨N ƒê∆Ø·ª¢C TIN QU√ÅI CH·∫æT
bindable.Event:Connect(function(player)
	print("üíé GemSystem: Nh·∫≠n ƒë∆∞·ª£c tin qu√°i ch·∫øt t·ª´ " .. player.Name)

	if math.random() <= DROP_CHANCE then
		-- L·∫•y danh s√°ch t·∫•t c·∫£ Gem t·ª´ Config
		local list = {}
		for id, _ in pairs(GemConfig) do
			table.insert(list, id)
		end

		if #list > 0 then
			-- Ch·ªçn b·ª´a 1 vi√™n
			local gemID = list[math.random(1, #list)]
			print("üé≤ ƒê√£ random ra ng·ªçc: " .. gemID .. " -> G·ª≠i cho Client...")

			-- G·ª≠i v·ªÅ cho ng∆∞·ªùi ch∆°i
			remoteGemDrop:FireClient(player, gemID)
		else
			warn("‚ö†Ô∏è GemConfig ƒëang r·ªóng! H√£y th√™m ng·ªçc v√†o file Config.")
		end
	else
		print("‚ùå Kh√¥ng r·ªõt ƒë·ªì (Do t·ª∑ l·ªá)")
	end
end)
-- ... (Gi·ªØ nguy√™n code c≈© c·ªßa GemSystem ·ªü tr√™n)

-- [M·ªöI] T·∫†O S·ª∞ KI·ªÜN TRANG B·ªä
local remoteEquip = ReplicatedStorage:FindFirstChild("SuKienTrangBiGem") or Instance.new("RemoteEvent")
remoteEquip.Name = "SuKienTrangBiGem"
remoteEquip.Parent = ReplicatedStorage

-- X·ª¨ L√ù KHI NG∆Ø·ªúI CH∆†I L·∫ÆP NG·ªåC
remoteEquip.OnServerEvent:Connect(function(player, gemID, unitModel)
	if not unitModel or not unitModel:FindFirstChild("Humanoid") then return end

	-- Ki·ªÉm tra xem l√≠nh c√≥ thu·ªôc v·ªÅ ng∆∞·ªùi ch∆°i kh√¥ng (tr√°nh hack)
	local chuSoHuu = unitModel:GetAttribute("ChuSoHuu")
	-- (N·∫øu game b·∫°n ch∆∞a set Attribute ChuSoHuu th√¨ t·∫°m b·ªè qua d√≤ng n√†y)

	print("‚úÖ Server: ƒê√£ l·∫Øp ng·ªçc " .. gemID .. " cho " .. unitModel.Name)

	-- G·∫ÆN M√ÅC NG·ªåC V√ÄO L√çNH
	-- UnitAI s·∫Ω ƒë·ªçc c√°i n√†y ƒë·ªÉ bi·∫øt l√≠nh ƒëang d√πng chi√™u g√¨
	unitModel:SetAttribute("GemID", gemID)

	-- [HI·ªÜU ·ª®NG] T·∫°o v√≤ng s√°ng b√°o hi·ªáu th√†nh c√¥ng
	local highlight = Instance.new("Highlight")
	highlight.FillColor = Color3.fromRGB(255, 255, 255)
	highlight.OutlineColor = GemConfig[gemID].Color
	highlight.Parent = unitModel

	game.Debris:AddItem(highlight, 0.5) -- X√≥a hi·ªáu ·ª©ng sau 0.5s
end)
