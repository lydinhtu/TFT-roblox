-- File: StarterGui/UnitInfoUI (LocalScript)
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local GemConfig = require(ReplicatedStorage:WaitForChild("GemConfig"))

-- T·∫°o Event ƒë·ªÉ nh·∫≠n t√≠n hi·ªáu khi ch·ªçn l√≠nh (N·∫øu ch∆∞a c√≥ th√¨ t·∫°o)
local eventChonUnit = ReplicatedStorage:FindFirstChild("SuKienChonUnit")
if not eventChonUnit then
	eventChonUnit = Instance.new("BindableEvent")
	eventChonUnit.Name = "SuKienChonUnit"
	eventChonUnit.Parent = ReplicatedStorage
end

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- === 1. T·∫†O GIAO DI·ªÜN (T·ª∞ ƒê·ªòNG V·∫º) ===
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "UnitInfoGUI"
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0.2, 0, 0.6, 0) -- R·ªông 20%, Cao 60%
mainFrame.Position = UDim2.new(0.8, -10, 0.2, 0) -- N·∫±m b√™n ph·∫£i
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
mainFrame.BorderSizePixel = 2
mainFrame.BorderColor3 = Color3.fromRGB(255, 215, 0)
mainFrame.Visible = false -- M·∫∑c ƒë·ªãnh ·∫©n
mainFrame.Parent = screenGui

-- [PH·∫¶N A] ·∫¢NH T∆Ø·ªöNG (ViewportFrame)
local viewContainer = Instance.new("Frame")
viewContainer.Name = "PartA_Image"
viewContainer.Size = UDim2.new(0.9, 0, 0.35, 0)
viewContainer.Position = UDim2.new(0.05, 0, 0.02, 0)
viewContainer.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
viewContainer.Parent = mainFrame

local viewport = Instance.new("ViewportFrame")
viewport.Size = UDim2.new(1, 0, 1, 0)
viewport.BackgroundTransparency = 1
viewport.Parent = viewContainer

local unitNameLabel = Instance.new("TextLabel")
unitNameLabel.Size = UDim2.new(1, 0, 0.2, 0)
unitNameLabel.Position = UDim2.new(0, 0, 0.8, 0)
unitNameLabel.BackgroundTransparency = 0.5
unitNameLabel.BackgroundColor3 = Color3.new(0,0,0)
unitNameLabel.TextColor3 = Color3.new(1,1,1)
unitNameLabel.Font = Enum.Font.FredokaOne
unitNameLabel.TextSize = 18
unitNameLabel.Text = "T√™n T∆∞·ªõng"
unitNameLabel.Parent = viewContainer

-- [PH·∫¶N B] CH·ªà S·ªê (Stats)
local statsContainer = Instance.new("Frame")
statsContainer.Name = "PartB_Stats"
statsContainer.Size = UDim2.new(0.9, 0, 0.35, 0)
statsContainer.Position = UDim2.new(0.05, 0, 0.39, 0)
statsContainer.BackgroundTransparency = 1
statsContainer.Parent = mainFrame

local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 5)
listLayout.Parent = statsContainer

local function TaoDongStat(ten, icon)
	local f = Instance.new("Frame")
	f.Size = UDim2.new(1, 0, 0.2, 0)
	f.BackgroundTransparency = 1
	f.Parent = statsContainer

	local lbl = Instance.new("TextLabel")
	lbl.Size = UDim2.new(1, 0, 1, 0)
	lbl.BackgroundTransparency = 1
	lbl.TextColor3 = Color3.new(1, 1, 1)
	lbl.Font = Enum.Font.SourceSansBold
	lbl.TextSize = 16
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.Text = icon .. " " .. ten .. ": 0"
	lbl.Name = "Label"
	lbl.Parent = f
	return lbl
end

local lblSatThuong = TaoDongStat("S√°t Th∆∞∆°ng", "‚öîÔ∏è")
local lblTocDanh = TaoDongStat("T·ªëc ƒê√°nh", "‚ö°")
local lblTamDanh = TaoDongStat("T·∫ßm ƒê√°nh", "üéØ")
local lblMau = TaoDongStat("M√°u", "‚ù§Ô∏è")

-- [PH·∫¶N C] C√ÅC √î NG·ªåC (Gems)
local gemContainer = Instance.new("Frame")
gemContainer.Name = "PartC_Gems"
gemContainer.Size = UDim2.new(0.9, 0, 0.2, 0)
gemContainer.Position = UDim2.new(0.05, 0, 0.76, 0)
gemContainer.BackgroundTransparency = 1
gemContainer.Parent = mainFrame

local titleGem = Instance.new("TextLabel")
titleGem.Text = "Trang B·ªã"
titleGem.Size = UDim2.new(1, 0, 0.2, 0)
titleGem.BackgroundTransparency = 1
titleGem.TextColor3 = Color3.fromRGB(255, 215, 0)
titleGem.Font = Enum.Font.FredokaOne
titleGem.Parent = gemContainer

local gridGem = Instance.new("UIGridLayout")
gridGem.CellSize = UDim2.new(0.22, 0, 0.7, 0) -- 4 √¥
gridGem.Parent = gemContainer

local gemSlots = {}
for i = 1, 4 do
	local slot = Instance.new("ImageButton")
	slot.Name = "Slot"..i
	slot.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
	slot.Image = "" -- Tr·ªëng
	slot.Parent = gemContainer

	local corner = Instance.new("UICorner")
	corner.Parent = slot

	table.insert(gemSlots, slot)
end

-- === 2. LOGIC C·∫¨P NH·∫¨T TH√îNG TIN ===
local currentUnit = nil
local connections = {} -- ƒê·ªÉ x√≥a s·ª± ki·ªán c≈© tr√°nh lag

local function XoaKetNoiCu()
	for _, c in pairs(connections) do c:Disconnect() end
	connections = {}
end

local function CapNhatHinhAnh3D(unitModel)
	viewport:ClearAllChildren()

	-- T·∫°o Camera ·∫£o
	local cam = Instance.new("Camera")
	cam.FieldOfView = 25
	viewport.CurrentCamera = cam
	viewport.Parent = viewContainer
	cam.Parent = viewport

	-- Clone con l√≠nh v√†o khung
	local clone = unitModel:Clone()
	clone.Parent = viewport

	-- X√≥a c√°c script trong clone ƒë·ªÉ n√≥ ƒë·ª©ng y√™n
	for _, s in pairs(clone:GetDescendants()) do
		if s:IsA("Script") or s:IsA("LocalScript") then s:Destroy() end
	end

	-- ƒê·∫∑t Camera nh√¨n v√†o l√≠nh
	local root = clone:FindFirstChild("HumanoidRootPart")
	if root then
		cam.CFrame = CFrame.new(root.Position + Vector3.new(3, 2, 6), root.Position)
	end
end

local function CapNhatNgoc(unitModel)
	-- Reset 4 √¥ v·ªÅ tr·ªëng
	for i = 1, 4 do
		gemSlots[i].Image = ""
		gemSlots[i].BackgroundColor3 = Color3.fromRGB(50, 50, 60)
	end

	-- Slot 1: Ng·ªçc Ch√≠nh (GemMain)
	local mainID = unitModel:GetAttribute("GemMain")
	if mainID and GemConfig[mainID] then
		gemSlots[1].Image = GemConfig[mainID].Icon
		gemSlots[1].BackgroundColor3 = GemConfig[mainID].Color
	end

	-- Slot 2: Ng·ªçc H·ªó Tr·ª£ (GemSupport)
	local suppID = unitModel:GetAttribute("GemSupport")
	if suppID and GemConfig[suppID] then
		gemSlots[2].Image = GemConfig[suppID].Icon
		gemSlots[2].BackgroundColor3 = GemConfig[suppID].Color
	end

	-- Slot 3 & 4: T·∫°m th·ªùi kh√≥a ho·∫∑c m·ªü r·ªông sau n√†y
end

local function HienThiThongTin(unitModel)
	if not unitModel or not unitModel:FindFirstChild("Humanoid") then 
		mainFrame.Visible = false
		return 
	end

	currentUnit = unitModel
	mainFrame.Visible = true
	XoaKetNoiCu()

	-- 1. C·∫≠p nh·∫≠t T√™n & ·∫¢nh
	unitNameLabel.Text = unitModel:GetAttribute("TenUnit") or unitModel.Name
	CapNhatHinhAnh3D(unitModel)

	-- 2. C·∫≠p nh·∫≠t Ch·ªâ s·ªë & L·∫Øng nghe thay ƒë·ªïi (Realtime)
	local hum = unitModel.Humanoid
	local stats = hum:WaitForChild("Stats")

	local function UpdateText()
		lblSatThuong.Text = "‚öîÔ∏è S√°t Th∆∞∆°ng: " .. tostring(stats.SatThuong.Value)
		lblTocDanh.Text = "‚ö° T·ªëc ƒê√°nh: " .. tostring(stats.TocDoDanh.Value)
		lblTamDanh.Text = "üéØ T·∫ßm ƒê√°nh: " .. tostring(stats.TamDanh.Value)
		lblMau.Text = "‚ù§Ô∏è M√°u: " .. math.floor(hum.Health) .. "/" .. math.floor(hum.MaxHealth)
	end

	UpdateText() -- C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c

	-- ƒêƒÉng k√Ω s·ª± ki·ªán thay ƒë·ªïi (ƒê·ªÉ khi l√™n c·∫•p ho·∫∑c l·∫Øp ng·ªçc n√≥ t·ª± nh·∫£y s·ªë)
	table.insert(connections, stats.SatThuong.Changed:Connect(UpdateText))
	table.insert(connections, stats.TocDoDanh.Changed:Connect(UpdateText))
	table.insert(connections, hum.HealthChanged:Connect(UpdateText))

	-- 3. C·∫≠p nh·∫≠t Ng·ªçc
	CapNhatNgoc(unitModel)

	-- L·∫Øng nghe n·∫øu l·∫Øp ng·ªçc m·ªõi th√¨ c·∫≠p nh·∫≠t l·∫°i √¥ ng·ªçc
	table.insert(connections, unitModel.AttributeChanged:Connect(function(attr)
		if attr == "GemMain" or attr == "GemSupport" then
			CapNhatNgoc(unitModel)
		end
	end))
end

-- L·∫ÆNG NGHE S·ª∞ KI·ªÜN CH·ªåN T·ª™ SCRIPT SO TIEN
eventChonUnit.Event:Connect(function(unitModel)
	HienThiThongTin(unitModel)
end)
