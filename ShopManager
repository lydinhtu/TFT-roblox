local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local workspace = game:GetService("Workspace")
local funcMuaLinh = ReplicatedStorage:WaitForChild("ChucNangMuaLinh")

local folderTuongMau = ServerStorage:WaitForChild("TuongMau") 
local GIA_TIEN_CO_BAN = 10
local folderHangCho = workspace:WaitForChild("HangCho")
local MAX_SLOTS = 8 

-- [FIX L·ªñI CH·ªíNG L·∫§N] H√†m ki·ªÉm tra b·ªè qua tr·ª•c Y
local function KiemTraOTrong(position)
	-- √âp v·ªã tr√≠ c·∫ßn ki·ªÉm tra v·ªÅ m·∫∑t ƒë·∫•t (Y=0)
	local posCanKiemTra = Vector3.new(position.X, 0, position.Z)

	for _, v in pairs(workspace:GetChildren()) do
		local root = v:FindFirstChild("HumanoidRootPart")
		if root then
			-- √âp v·ªã tr√≠ c·ªßa l√≠nh ƒëang ƒë·ª©ng v·ªÅ m·∫∑t ƒë·∫•t (Y=0)
			local posLinh = Vector3.new(root.Position.X, 0, root.Position.Z)

			-- So s√°nh kho·∫£ng c√°ch tr√™n m·∫∑t ph·∫≥ng ngang
			if (posLinh - posCanKiemTra).Magnitude < 2 then
				return false -- ƒê√£ c√≥ ng∆∞·ªùi ƒë·ª©ng (b·∫•t k·ªÉ ƒëang bay hay ƒë·ª©ng d∆∞·ªõi ƒë·∫•t)
			end
		end
	end
	return true 
end

-- === H√ÄM X·ª¨ L√ù TƒÇNG SAO ===
local function XuLyNangCap(player, tenUnit, levelHienTai)
	local dsLinhGiongNhau = {}

	for _, unit in pairs(workspace:GetChildren()) do
		local hum = unit:FindFirstChild("Humanoid")
		if hum then 
			local chuSoHuu = unit:GetAttribute("ChuSoHuu")
			local ten = unit:GetAttribute("TenUnit")

			local lvlVal = 1
			local stats = hum:FindFirstChild("Stats")
			if stats and stats:FindFirstChild("Level") then
				lvlVal = stats.Level.Value
			end

			if chuSoHuu == player.Name and ten == tenUnit and lvlVal == levelHienTai then
				table.insert(dsLinhGiongNhau, unit)
			end
		end
	end

	if #dsLinhGiongNhau >= 3 then
		print("üåü TI·∫æN H√ÄNH N√ÇNG C·∫§P " .. tenUnit .. " L√äN C·∫§P " .. (levelHienTai + 1))

		local unitCuoi = dsLinhGiongNhau[#dsLinhGiongNhau]
		local rootCuoi = unitCuoi:FindFirstChild("HumanoidRootPart")
		-- L·∫•y v·ªã tr√≠ an to√†n, n·∫øu m·∫•t Root th√¨ l·∫•y m·∫∑c ƒë·ªãnh
		local viTriMoi = rootCuoi and rootCuoi.CFrame or CFrame.new(0, 5, 0)

		-- X√≥a 3 con c≈©
		for i = 1, 3 do
			local u = dsLinhGiongNhau[i]
			local r = u:FindFirstChild("HumanoidRootPart")
			if r then
				local hieuUng = Instance.new("Explosion")
				hieuUng.Position = r.Position
				hieuUng.BlastPressure = 0
				hieuUng.BlastRadius = 4
				hieuUng.Parent = workspace
			end
			u:Destroy()
		end

		-- T·∫°o con m·ªõi
		local mauUnit = folderTuongMau:FindFirstChild(tenUnit)
		if mauUnit then
			local unitMoi = mauUnit:Clone()
			unitMoi.Parent = workspace
			unitMoi.Name = "Linh_" .. player.Name .. "_LV" .. (levelHienTai + 1)
			unitMoi:SetAttribute("ChuSoHuu", player.Name)
			unitMoi:SetAttribute("TenUnit", tenUnit)
			unitMoi:SetAttribute("DaRaTran", false)

			if unitMoi:FindFirstChild("HumanoidRootPart") then
				unitMoi.HumanoidRootPart.CFrame = viTriMoi
			end

			-- C·∫≠p nh·∫≠t ch·ªâ s·ªë
			local s = unitMoi.Humanoid:FindFirstChild("Stats")
			if s then
				if not s:FindFirstChild("Level") then
					local lv = Instance.new("IntValue", s)
					lv.Name = "Level"
				end
				s.Level.Value = levelHienTai + 1

				unitMoi.Humanoid.MaxHealth = unitMoi.Humanoid.MaxHealth * 1.8
				unitMoi.Humanoid.Health = unitMoi.Humanoid.MaxHealth

				local satThuong = s:FindFirstChild("SatThuong")
				if satThuong then satThuong.Value = satThuong.Value * 1.5 end

				local highlight = Instance.new("Highlight")
				highlight.FillColor = Color3.fromRGB(255, 215, 0)
				highlight.Parent = unitMoi
			end

			-- Ki·ªÉm tra ti·∫øp (3 sao -> 4 sao n·∫øu c√≥)
			task.wait(0.1)
			XuLyNangCap(player, tenUnit, levelHienTai + 1)
		end
	end
end

-- === LOGIC MUA L√çNH ===
funcMuaLinh.OnServerInvoke = function(player, tenUnitCanMua)
	local stats = player:FindFirstChild("leaderstats")
	if not stats then return "Loi" end

	local giaTien = 10
	if tenUnitCanMua == "LinhTa2" then giaTien = 20 end

	if stats.Gold.Value < giaTien then return "HetTien" end

	-- T√¨m √¥ tr·ªëng
	local slotTimDuoc = nil
	for i = 1, MAX_SLOTS do
		local slotPart = folderHangCho:FindFirstChild("Slot_" .. i)
		-- Ki·ªÉm tra xem √¥ n√†y c√≥ tr·ªëng kh√¥ng (D√πng h√†m ƒë√£ s·ª≠a l·ªói)
		if slotPart and KiemTraOTrong(slotPart.Position) then
			slotTimDuoc = slotPart
			break
		end
	end

	if slotTimDuoc == nil then return "HetCho" end

	-- Tr·ª´ ti·ªÅn & Sinh l√≠nh
	stats.Gold.Value = stats.Gold.Value - giaTien

	local mauUnit = folderTuongMau:FindFirstChild(tenUnitCanMua)
	if not mauUnit then return "LoiData" end

	local linhMoi = mauUnit:Clone()
	linhMoi.Parent = workspace
	linhMoi.Name = "Linh_" .. player.Name .. "_" .. math.random(1,1000)

	linhMoi:SetAttribute("ChuSoHuu", player.Name)
	linhMoi:SetAttribute("TenUnit", tenUnitCanMua)
	linhMoi:SetAttribute("DaRaTran", false)

	if linhMoi:FindFirstChild("HumanoidRootPart") then
		-- ƒê·∫∑t l√≠nh cao h∆°n 1 ch√∫t ƒë·ªÉ kh√¥ng k·∫πt ƒë·∫•t
		linhMoi.HumanoidRootPart.CFrame = slotTimDuoc.CFrame + Vector3.new(0, 3, 0)
	end

	local s = linhMoi.Humanoid:FindFirstChild("Stats")
	if s then
		local lv = s:FindFirstChild("Level") or Instance.new("IntValue", s)
		lv.Name = "Level"
		lv.Value = 1
	end

	-- Ki·ªÉm tra n√¢ng c·∫•p ngay sau khi mua
	task.spawn(function()
		XuLyNangCap(player, tenUnitCanMua, 1)
	end)

	return "ThanhCong"
end
