-- === Script: ShopManager (ƒê√£ n√¢ng c·∫•p) ===
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local workspace = game:GetService("Workspace")
local funcMuaLinh = ReplicatedStorage:WaitForChild("ChucNangMuaLinh")

-- Folder ch·ª©a t∆∞·ªõng m·∫´u trong ServerStorage
local folderTuongMau = ServerStorage:WaitForChild("TuongMau") -- L∆ØU √ù: B·∫°n h√£y t·∫°o Folder n√†y v√† b·ªè LinhTa, LinhTa2 v√†o ƒë√≥
local GIA_TIEN_CO_BAN = 10
local folderHangCho = workspace:WaitForChild("HangCho")
local MAX_SLOTS = 8 

-- H√†m ki·ªÉm tra v·ªã tr√≠ tr·ªëng (Gi·ªØ nguy√™n logic c≈©)
local function KiemTraOTrong(position)
	for _, v in pairs(workspace:GetChildren()) do
		if v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
			if (v.HumanoidRootPart.Position - position).Magnitude < 2 then
				return false 
			end
		end
	end
	return true 
end

-- === H√ÄM X·ª¨ L√ù TƒÇNG SAO (M·ªöI) ===
local function XuLyNangCap(player, tenUnit, levelHienTai)
	-- 1. T√¨m t·∫•t c·∫£ l√≠nh c·ªßa ng∆∞·ªùi ch∆°i n√†y, c√πng t√™n, c√πng c·∫•p
	local dsLinhGiongNhau = {}

	for _, unit in pairs(workspace:GetChildren()) do
		local chuSoHuu = unit:GetAttribute("ChuSoHuu")
		local ten = unit:GetAttribute("TenUnit")

		-- L·∫•y level t·ª´ Stats
		local lvlVal = 1
		local stats = unit:FindFirstChild("Humanoid") and unit.Humanoid:FindFirstChild("Stats")
		if stats and stats:FindFirstChild("Level") then
			lvlVal = stats.Level.Value
		end

		if chuSoHuu == player.Name and ten == tenUnit and lvlVal == levelHienTai then
			table.insert(dsLinhGiongNhau, unit)
		end
	end

	-- 2. N·∫øu ƒë·ªß 3 con -> G·ªòP
	if #dsLinhGiongNhau >= 3 then
		print("üåü ƒê√É ƒê·ª¶ 3 CON " .. tenUnit .. " C·∫§P " .. levelHienTai .. "! TI·∫æN H√ÄNH N√ÇNG C·∫§P!")

		-- L·∫•y v·ªã tr√≠ c·ªßa con cu·ªëi c√πng (ƒë·ªÉ con m·ªõi xu·∫•t hi·ªán t·∫°i ƒë√≥)
		local unitCuoi = dsLinhGiongNhau[#dsLinhGiongNhau]
		local viTriMoi = unitCuoi.HumanoidRootPart.CFrame

		-- X√≥a 3 con c≈©
		for i = 1, 3 do
			local hieuUng = Instance.new("Explosion") -- Hi·ªáu ·ª©ng n·ªï nh·ªè cho ƒë·∫πp
			hieuUng.Position = dsLinhGiongNhau[i].HumanoidRootPart.Position
			hieuUng.Parent = workspace
			dsLinhGiongNhau[i]:Destroy()
		end

		-- T·∫°o con m·ªõi (C·∫•p cao h∆°n)
		local mauUnit = folderTuongMau:FindFirstChild(tenUnit)
		if mauUnit then
			local unitMoi = mauUnit:Clone()
			unitMoi.Parent = workspace
			unitMoi.Name = "Linh_" .. player.Name .. "_LV" .. (levelHienTai + 1)
			unitMoi:SetAttribute("ChuSoHuu", player.Name)
			unitMoi:SetAttribute("TenUnit", tenUnit)
			unitMoi:SetAttribute("DaRaTran", false) -- M·∫∑c ƒë·ªãnh ·ªü h√†ng ch·ªù/s√†n ƒë·∫•u t√πy logic, t·∫°m ƒë·ªÉ false

			unitMoi.HumanoidRootPart.CFrame = viTriMoi

			-- C·∫≠p nh·∫≠t Level m·ªõi
			local s = unitMoi.Humanoid:FindFirstChild("Stats")
			if s then
				if not s:FindFirstChild("Level") then
					local lv = Instance.new("IntValue", s)
					lv.Name = "Level"
				end
				s.Level.Value = levelHienTai + 1

				-- TƒÇNG CH·ªà S·ªê S·ª®C M·∫†NH THEO SAO
				unitMoi.Humanoid.MaxHealth = unitMoi.Humanoid.MaxHealth * 1.8 -- M√°u g·∫•p 1.8 l·∫ßn
				unitMoi.Humanoid.Health = unitMoi.Humanoid.MaxHealth
				local satThuong = s:FindFirstChild("SatThuong")
				if satThuong then
					satThuong.Value = satThuong.Value * 1.5 -- Dame g·∫•p 1.5 l·∫ßn
				end

				-- ƒê·ªïi m√†u ch√∫t ƒë·ªÉ nh·∫≠n bi·∫øt (N·∫øu mu·ªën)
				local highlight = Instance.new("Highlight")
				highlight.FillColor = Color3.fromRGB(255, 215, 0) -- M√†u v√†ng
				highlight.Parent = unitMoi
			end

			-- ƒê·ªá quy: Ki·ªÉm tra ti·∫øp xem c√≥ ƒë·ªß 3 con c·∫•p cao v·ª´a t·∫°o kh√¥ng (V√≠ d·ª• 3 con 2 sao -> 1 con 3 sao)
			task.wait(0.1)
			XuLyNangCap(player, tenUnit, levelHienTai + 1)
		end
	end
end

-- === LOGIC MUA L√çNH ===
funcMuaLinh.OnServerInvoke = function(player, tenUnitCanMua) -- Th√™m tham s·ªë t√™n Unit
	local stats = player:FindFirstChild("leaderstats")
	if not stats then return "Loi" end

	-- X√°c ƒë·ªãnh gi√° ti·ªÅn (V√≠ d·ª•)
	local giaTien = 10
	if tenUnitCanMua == "LinhTa2" then giaTien = 20 end

	if stats.Gold.Value < giaTien then return "HetTien" end

	-- T√¨m √¥ tr·ªëng
	local slotTimDuoc = nil
	for i = 1, MAX_SLOTS do
		local slotPart = folderHangCho:FindFirstChild("Slot_" .. i)
		if slotPart and KiemTraOTrong(slotPart.Position) then
			slotTimDuoc = slotPart
			break
		end
	end
	if slotTimDuoc == nil then return "HetCho" end

	-- Tr·ª´ ti·ªÅn & Sinh l√≠nh
	stats.Gold.Value = stats.Gold.Value - giaTien

	local mauUnit = folderTuongMau:FindFirstChild(tenUnitCanMua)
	if not mauUnit then return "LoiData" end -- ƒê·∫£m b·∫£o c√≥ m·∫´u

	local linhMoi = mauUnit:Clone()
	linhMoi.Parent = workspace
	linhMoi.Name = "Linh_" .. player.Name .. "_" .. math.random(1,1000)

	-- G√°n c√°c Attribute quan tr·ªçng ƒë·ªÉ qu·∫£n l√Ω
	linhMoi:SetAttribute("ChuSoHuu", player.Name)
	linhMoi:SetAttribute("TenUnit", tenUnitCanMua)
	linhMoi:SetAttribute("DaRaTran", false)

	linhMoi.HumanoidRootPart.CFrame = slotTimDuoc.CFrame + Vector3.new(0, 3, 0)

	-- G√°n Level 1 m·∫∑c ƒë·ªãnh
	local s = linhMoi.Humanoid:FindFirstChild("Stats")
	if s then
		local lv = s:FindFirstChild("Level") or Instance.new("IntValue", s)
		lv.Name = "Level"
		lv.Value = 1
	end

	-- SAU KHI MUA -> KI·ªÇM TRA N√ÇNG C·∫§P NGAY
	task.spawn(function()
		XuLyNangCap(player, tenUnitCanMua, 1)
	end)

	return "ThanhCong"
end
