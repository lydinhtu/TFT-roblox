local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local workspace = game:GetService("Workspace")
local funcMuaLinh = ReplicatedStorage:WaitForChild("ChucNangMuaLinh")

local linhMau = ServerStorage:WaitForChild("LinhTa") 
local GIA_TIEN = 10
local folderHangCho = workspace:WaitForChild("HangCho")
local MAX_SLOTS = 8 -- Số lượng ô hàng chờ

-- Hàm kiểm tra xem một vị trí có ai đứng chưa
local function KiemTraOTrong(position)
	-- Quét tất cả các con lính đang có trên map
	for _, v in pairs(workspace:GetChildren()) do
		if v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
			-- Nếu có con lính nào đứng cách tâm ô dưới 2 mét -> Coi như ô đó đã có người
			if (v.HumanoidRootPart.Position - position).Magnitude < 2 then
				return false -- Không trống
			end
		end
	end
	return true -- Trống
end

funcMuaLinh.OnServerInvoke = function(player)
	local stats = player:FindFirstChild("leaderstats")
	if not stats then return "Loi" end
	local gold = stats.Gold

	if gold.Value < GIA_TIEN then return "HetTien" end

	-- 1. TÌM Ô TRỐNG THỰC TẾ
	local slotTimDuoc = nil

	for i = 1, MAX_SLOTS do
		local tenSlot = "Slot_" .. i
		local slotPart = folderHangCho:FindFirstChild(tenSlot)

		if slotPart then
			-- Kiểm tra xem ô này có trống không
			if KiemTraOTrong(slotPart.Position) then
				slotTimDuoc = slotPart
				break -- Tìm thấy rồi thì dừng
			end
		end
	end

	if slotTimDuoc == nil then return "HetCho" end

	-- 2. TRỪ TIỀN VÀ SINH LÍNH
	gold.Value = gold.Value - GIA_TIEN

	local linhMoi = linhMau:Clone()
	linhMoi.Parent = workspace
	linhMoi.Name = "Linh_" .. player.Name .. "_" .. math.random(1, 10000)

	if linhMoi:FindFirstChild("Humanoid") then
		linhMoi.Humanoid.DisplayName = "Chiến Binh"
	end

	if linhMoi:FindFirstChild("HumanoidRootPart") then
		-- Đặt vào đúng vị trí ô tìm được
		linhMoi.HumanoidRootPart.CFrame = slotTimDuoc.CFrame + Vector3.new(0, 3, 0)
	end

	-- Mới mua về thì ở hàng chờ -> Chưa ra trận
	linhMoi:SetAttribute("DaRaTran", false)

	-- Gán Level
	local s = linhMoi.Humanoid:FindFirstChild("Stats")
	if s and not s:FindFirstChild("Level") then
		local lv = Instance.new("IntValue")
		lv.Name = "Level"
		lv.Value = 1
		lv.Parent = s
	end

	return "ThanhCong"
end
