-- === Script: ShopSystem (Client) ===
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local funcMuaLinh = ReplicatedStorage:WaitForChild("ChucNangMuaLinh")
-- [MỚI] Lấy biến trạng thái
local DangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")

local player = Players.LocalPlayer

local DANH_SACH_POOL = {"LinhTa", "LinhTa2"}
local GIA_REROLL = 2

-- === 1. TẠO GIAO DIỆN ===
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ShopUI"
screenGui.Parent = player:WaitForChild("PlayerGui")

local shopFrame = Instance.new("Frame")
shopFrame.Name = "ShopFrame"
shopFrame.Size = UDim2.new(0.6, 0, 0.15, 0)
shopFrame.Position = UDim2.new(0.2, 0, 0.85, 0)
shopFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
shopFrame.BorderSizePixel = 2
shopFrame.BorderColor3 = Color3.fromRGB(255, 215, 0)
shopFrame.Parent = screenGui

local title = Instance.new("TextLabel")
title.Text = "CỬA HÀNG"
title.Size = UDim2.new(1, 0, 0.2, 0)
title.Position = UDim2.new(0, 0, -0.2, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.FredokaOne
title.TextSize = 20
title.Parent = shopFrame

local lblCount = Instance.new("TextLabel")
lblCount.Name = "UnitCount"
lblCount.Text = "Lính: 0"
lblCount.Size = UDim2.new(0.2, 0, 0.5, 0)
lblCount.Position = UDim2.new(0.8, 0, -0.5, 0)
lblCount.BackgroundTransparency = 1
lblCount.TextColor3 = Color3.new(1, 1, 1)
lblCount.Font = Enum.Font.SourceSansBold
lblCount.TextSize = 18
lblCount.Parent = shopFrame

local btnReroll = Instance.new("TextButton")
btnReroll.Name = "RerollBtn"
btnReroll.Text = "Đổi Lại (" .. GIA_REROLL .. "G)"
btnReroll.Size = UDim2.new(0.15, 0, 0.8, 0)
btnReroll.Position = UDim2.new(0.02, 0, 0.1, 0)
btnReroll.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
btnReroll.TextColor3 = Color3.new(1, 1, 1)
btnReroll.Font = Enum.Font.SourceSansBold
btnReroll.TextSize = 18
btnReroll.Parent = shopFrame
local uiCorner = Instance.new("UICorner", btnReroll)

local container = Instance.new("Frame")
container.Size = UDim2.new(0.8, 0, 1, 0)
container.Position = UDim2.new(0.2, 0, 0, 0)
container.BackgroundTransparency = 1
container.Parent = shopFrame

local gridLayout = Instance.new("UIGridLayout")
gridLayout.CellSize = UDim2.new(0.18, 0, 0.9, 0)
gridLayout.CellPadding = UDim2.new(0.02, 0, 0, 0)
gridLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
gridLayout.VerticalAlignment = Enum.VerticalAlignment.Center
gridLayout.Parent = container

-- === 2. HÀM TẠO THẺ BÀI ===
local function TaoTheBai(tenUnit)
	local card = Instance.new("TextButton")
	card.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
	card.Text = ""
	card.AutoButtonColor = true
	card.Parent = container

	local uiStroke = Instance.new("UIStroke")
	uiStroke.Thickness = 2
	uiStroke.Color = Color3.fromRGB(100, 100, 100)
	uiStroke.Parent = card

	local lblName = Instance.new("TextLabel")
	lblName.Text = tenUnit
	lblName.Size = UDim2.new(1, 0, 0.3, 0)
	lblName.BackgroundTransparency = 1
	lblName.TextColor3 = Color3.new(1, 1, 1)
	lblName.Font = Enum.Font.SourceSansBold
	lblName.TextSize = 16
	lblName.Parent = card

	local gia = 10
	if tenUnit == "LinhTa2" then gia = 20 end

	local lblPrice = Instance.new("TextLabel")
	lblPrice.Text = gia .. " Vàng"
	lblPrice.Size = UDim2.new(1, 0, 0.3, 0)
	lblPrice.Position = UDim2.new(0, 0, 0.7, 0)
	lblPrice.BackgroundTransparency = 1
	lblPrice.TextColor3 = Color3.fromRGB(255, 215, 0)
	lblPrice.Font = Enum.Font.SourceSansBold
	lblPrice.Parent = card

	if tenUnit == "LinhTa" then uiStroke.Color = Color3.fromRGB(255, 170, 0) end
	if tenUnit == "LinhTa2" then uiStroke.Color = Color3.fromRGB(0, 170, 255) end

	-- [CLICK MUA TƯỚNG]
	card.MouseButton1Click:Connect(function()
		-- [MỚI] Chặn mua khi đánh nhau
		if DangDanhNhau.Value == true then return end

		local ketQua = funcMuaLinh:InvokeServer(tenUnit)
		if ketQua == "ThanhCong" then
			card:Destroy()
		elseif ketQua == "HetTien" then
			lblPrice.TextColor3 = Color3.fromRGB(255, 0, 0)
			lblPrice.Text = "Thiếu Tiền!"
			task.wait(1)
			lblPrice.Text = gia .. " Vàng"
			lblPrice.TextColor3 = Color3.fromRGB(255, 215, 0)
		end
	end)
end

-- === 3. HÀM REROLL ===
local function RerollShop()
	for _, v in pairs(container:GetChildren()) do
		if v:IsA("TextButton") then v:Destroy() end
	end
	for i = 1, 5 do
		local randomUnit = DANH_SACH_POOL[math.random(1, #DANH_SACH_POOL)]
		TaoTheBai(randomUnit)
	end
end

-- [CLICK REROLL]
btnReroll.MouseButton1Click:Connect(function()
	-- [MỚI] Chặn reroll khi đánh nhau
	if DangDanhNhau.Value == true then return end

	RerollShop()
end)

RerollShop()

-- === 4. HỆ THỐNG ĐẾM LÍNH ===
task.spawn(function()
	while true do
		task.wait(0.5) 
		local soLuongLinh = 0

		for _, v in pairs(workspace:GetChildren()) do
			local human = v:FindFirstChild("Humanoid")
			local root = v:FindFirstChild("HumanoidRootPart")

			if human and root and not Players:GetPlayerFromCharacter(v) then
				if v:GetAttribute("DaChet") ~= true then
					soLuongLinh = soLuongLinh + 1
				end
			end
		end

		if lblCount then
			lblCount.Text = "Lính: " .. soLuongLinh
		end
	end
end)
