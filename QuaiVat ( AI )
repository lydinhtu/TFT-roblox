local npc = script.Parent
local humanoid = npc:WaitForChild("Humanoid")
local rootPart = npc:WaitForChild("HumanoidRootPart")

-- === KẾT NỐI VỚI CÔNG TẮC ===
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local bienDangDanhNhau = ReplicatedStorage:WaitForChild("DangDanhNhau")

-- === CẤU HÌNH ===
local KICH_THUOC_O = 6 

-- Tạo thư mục chứa các "Cục Gạch" xí chỗ (Nếu chưa có)
if not workspace:FindFirstChild("DatCho") then
	local folder = Instance.new("Folder")
	folder.Name = "DatCho"
	folder.Parent = workspace
end
local folderDatCho = workspace:FindFirstChild("DatCho")

-- Hàm tính tâm ô
local function LayTamO(position)
	local nuaO = KICH_THUOC_O / 2
	local x = (math.floor(position.X / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	local z = (math.floor(position.Z / KICH_THUOC_O) * KICH_THUOC_O) + nuaO
	return Vector3.new(x, rootPart.Position.Y, z)
end

-- [[ HÀM KIỂM TRA & XÍ CHỖ ]]
local function KiemTraVaDatCho(viTriMuonDen)
	-- 1. Kiểm tra xem có ai đang ĐỨNG đó không (Vật lý)
	for _, v in pairs(workspace:GetChildren()) do
		if v ~= npc and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
			local root = v:FindFirstChild("HumanoidRootPart") or v:FindFirstChild("RootPart")
			if root and (root.Position - viTriMuonDen).Magnitude < 3 then 
				return nil -- Đã có người đứng
			end
		end
	end

	-- 2. Kiểm tra xem có ai đã ĐẶT GẠCH chưa (Reservation)
	for _, gach in pairs(folderDatCho:GetChildren()) do
		if (gach.Position - viTriMuonDen).Magnitude < 1 then
			return nil -- Đã có thằng khác xí chỗ
		end
	end

	-- 3. Nếu trống -> Tạo cục gạch xí chỗ
	local gachMoi = Instance.new("Part")
	gachMoi.Name = "GachCua_" .. npc.Name
	gachMoi.Size = Vector3.new(1, 1, 1)
	gachMoi.Position = viTriMuonDen
	gachMoi.Anchored = true
	gachMoi.CanCollide = false -- Lính đi xuyên qua được
	gachMoi.Transparency = 1 -- Tàng hình (Sửa thành 0.5 nếu muốn nhìn thấy để debug)
	gachMoi.Parent = folderDatCho

	-- Tự hủy cục gạch sau 2 giây (đề phòng lính chết giữa đường mà quên dọn gạch)
	game:GetService("Debris"):AddItem(gachMoi, 2)

	return gachMoi -- Trả về cục gạch để lát nữa mình dọn
end

-- === ANIMATION & STATS ===
local animationId = "rbxassetid://507777826" 
local animObj = Instance.new("Animation")
animObj.AnimationId = animationId
local attackTrack = humanoid:LoadAnimation(animObj)

local stats = humanoid:WaitForChild("Stats")
local myTeam = stats:WaitForChild("Team").Value
local statsTamDanh = stats:WaitForChild("TamDanh")
local statsSatThuong = stats:WaitForChild("SatThuong")
local statsTocDoDanh = stats:WaitForChild("TocDoDanh")
local statsTocDoDiChuyen = stats:WaitForChild("TocDoDiChuyen")

humanoid.AutoRotate = false 
local daChet = false

-- Hàm dọn sạch gạch của bản thân khi chết
local function DonDepSachSe()
	for _, gach in pairs(folderDatCho:GetChildren()) do
		if gach.Name == "GachCua_" .. npc.Name then
			gach:Destroy()
		end
	end
end

humanoid.Died:Connect(function()
	daChet = true
	DonDepSachSe() -- Chết là phải dọn gạch
	if attackTrack then attackTrack:Stop() end
	rootPart.Anchored = false
	npc:BreakJoints()
	if rootPart:FindFirstChild("HealthBar") then rootPart.HealthBar:Destroy() end
	task.wait(2)
	npc:Destroy()
end)

-- === VÒNG LẶP CHÍNH ===
while not daChet do
	task.wait(0.1) 

	if bienDangDanhNhau.Value == false then
		humanoid.WalkSpeed = 0 
		if humanoid.Health < humanoid.MaxHealth then humanoid.Health = humanoid.MaxHealth end
		DonDepSachSe() -- Đang nghỉ thì không cần giữ chỗ
		continue 
	end

	humanoid.WalkSpeed = statsTocDoDiChuyen.Value

	-- 1. TÌM KẺ ĐỊCH
	local mucTieu = nil
	local minDst = math.huge

	for _, v in pairs(workspace:GetChildren()) do
		if v ~= npc and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
			local eRoot = v:FindFirstChild("HumanoidRootPart") or v:FindFirstChild("RootPart")
			local eStats = v.Humanoid:FindFirstChild("Stats")
			if eRoot and eStats and eStats:FindFirstChild("Team") then
				if eStats.Team.Value ~= myTeam then
					local dist = (rootPart.Position - eRoot.Position).Magnitude
					if dist < minDst then
						minDst = dist
						mucTieu = eRoot
					end
				end
			end
		end
	end

	if mucTieu then
		local tamO_Dich = LayTamO(mucTieu.Position)
		local tamO_Minh = LayTamO(rootPart.Position)

		local diffX = tamO_Dich.X - tamO_Minh.X
		local diffZ = tamO_Dich.Z - tamO_Minh.Z
		local khoangCachManhattan = math.abs(diffX) + math.abs(diffZ)

		-- TẤN CÔNG
		if khoangCachManhattan <= math.max(statsTamDanh.Value, KICH_THUOC_O) then
			rootPart.Anchored = true 
			DonDepSachSe() -- Đứng lại đánh thì dọn gạch đi cho đỡ rác

			local viTriDichY = Vector3.new(mucTieu.Position.X, rootPart.Position.Y, mucTieu.Position.Z)
			rootPart.CFrame = CFrame.lookAt(rootPart.Position, viTriDichY)

			attackTrack:Play()
			task.wait(0.3) 
			local eHum = mucTieu.Parent:FindFirstChild("Humanoid")
			if eHum and eHum.Health > 0 then eHum:TakeDamage(statsSatThuong.Value) end
			task.wait(statsTocDoDanh.Value - 0.3) 

		else
			-- DI CHUYỂN
			rootPart.Anchored = false 
			local oTiepTheo = tamO_Minh

			if math.abs(diffX) >= KICH_THUOC_O then
				oTiepTheo = tamO_Minh + Vector3.new(math.sign(diffX) * KICH_THUOC_O, 0, 0)
			elseif math.abs(diffZ) >= KICH_THUOC_O then
				oTiepTheo = tamO_Minh + Vector3.new(0, 0, math.sign(diffZ) * KICH_THUOC_O)
			end

			-- [[ BƯỚC QUAN TRỌNG: ĐẶT GẠCH TRƯỚC KHI ĐI ]]
			local cucGach = KiemTraVaDatCho(oTiepTheo)

			if cucGach then
				-- Đã xí được chỗ -> ĐI
				rootPart.CFrame = CFrame.lookAt(rootPart.Position, Vector3.new(oTiepTheo.X, rootPart.Position.Y, oTiepTheo.Z))
				humanoid:MoveTo(oTiepTheo)

				-- Đợi đi xong
				humanoid.MoveToFinished:Wait() 

				-- Đi tới nơi rồi thì xóa gạch đi (để nhường chỗ đó cho vật lý thật của mình chiếm giữ)
				if cucGach then cucGach:Destroy() end
			else
				-- Chỗ đó đã bị đứa khác xí hoặc đứng -> ĐỨNG CHỜ
				humanoid:MoveTo(rootPart.Position) 
				-- Thử một chút ngẫu nhiên để không bị kẹt mãi (Desync)
				task.wait(math.random(1, 3) * 0.1) 
			end
		end
	else
		-- Không có mục tiêu -> Dọn gạch
		DonDepSachSe()
	end
end
